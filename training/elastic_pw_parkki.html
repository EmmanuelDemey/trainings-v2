<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>elasticsearch_parkki_tp_jour1_installation_indexation</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#elasticsearch-parkki-training---practical-exercises"
id="toc-elasticsearch-parkki-training---practical-exercises">Elasticsearch
Parkki Training - Practical Exercises</a>
<ul>
<li><a href="#overview" id="toc-overview">Overview</a></li>
</ul></li>
<li><a href="#part-2-installation-and-configuration"
id="toc-part-2-installation-and-configuration">Part 2: Installation and
Configuration</a>
<ul>
<li><a
href="#exercise-2.1-starting-elasticsearch-and-kibana---local-installation"
id="toc-exercise-2.1-starting-elasticsearch-and-kibana---local-installation">Exercise
2.1: Starting Elasticsearch and Kibana - Local Installation</a>
<ul>
<li><a href="#step-1-install-and-start-elasticsearch"
id="toc-step-1-install-and-start-elasticsearch">Step 1: Install and
Start Elasticsearch</a></li>
<li><a href="#step-2-install-and-start-kibana"
id="toc-step-2-install-and-start-kibana">Step 2: Install and Start
Kibana</a></li>
<li><a href="#step-3-verify-installation"
id="toc-step-3-verify-installation">Step 3: Verify Installation</a></li>
<li><a href="#step-4-explore-cluster-information"
id="toc-step-4-explore-cluster-information">Step 4: Explore Cluster
Information</a></li>
</ul></li>
<li><a href="#exercise-2.2-node-configuration-analysis"
id="toc-exercise-2.2-node-configuration-analysis">Exercise 2.2: Node
Configuration Analysis</a></li>
</ul></li>
<li><a href="#part-3-indexing" id="toc-part-3-indexing">Part 3:
Indexing</a>
<ul>
<li><a href="#exercise-3.1-create-and-index-documents-with-validation"
id="toc-exercise-3.1-create-and-index-documents-with-validation">Exercise
3.1: Create and Index Documents with Validation</a></li>
<li><a href="#exercise-3.2-bulk-indexing-with-error-analysis"
id="toc-exercise-3.2-bulk-indexing-with-error-analysis">Exercise 3.2:
Bulk Indexing with Error Analysis</a></li>
<li><a href="#exercise-3.3-document-operations-crud-with-concurrency"
id="toc-exercise-3.3-document-operations-crud-with-concurrency">Exercise
3.3: Document Operations (CRUD) with Concurrency</a></li>
</ul></li>
<li><a href="#part-4-mapping" id="toc-part-4-mapping">Part 4:
Mapping</a>
<ul>
<li><a href="#exercise-4.1-explicit-mapping-with-analyzers"
id="toc-exercise-4.1-explicit-mapping-with-analyzers">Exercise 4.1:
Explicit Mapping with Analyzers</a></li>
<li><a href="#exercise-4.2-multi-fields-and-aggregation-optimization"
id="toc-exercise-4.2-multi-fields-and-aggregation-optimization">Exercise
4.2: Multi-fields and Aggregation Optimization</a></li>
<li><a href="#exercise-4.3-nested-objects-vs-flattened"
id="toc-exercise-4.3-nested-objects-vs-flattened">Exercise 4.3: Nested
Objects vs Flattened</a></li>
<li><a href="#exercise-4.4-index-templates-with-priority"
id="toc-exercise-4.4-index-templates-with-priority">Exercise 4.4: Index
Templates with Priority</a></li>
</ul></li>
<li><a href="#part-5-search" id="toc-part-5-search">Part 5: Search</a>
<ul>
<li><a href="#exercise-5.1-full-text-search-with-relevance-tuning"
id="toc-exercise-5.1-full-text-search-with-relevance-tuning">Exercise
5.1: Full-Text Search with Relevance Tuning</a></li>
<li><a href="#exercise-5.2-term-level-and-range-queries"
id="toc-exercise-5.2-term-level-and-range-queries">Exercise 5.2:
Term-Level and Range Queries</a></li>
<li><a href="#exercise-5.3-boolean-queries-with-scoring-control"
id="toc-exercise-5.3-boolean-queries-with-scoring-control">Exercise 5.3:
Boolean Queries with Scoring Control</a></li>
<li><a href="#exercise-5.4-geo-queries-and-distance-calculations"
id="toc-exercise-5.4-geo-queries-and-distance-calculations">Exercise
5.4: Geo Queries and Distance Calculations</a></li>
<li><a href="#exercise-5.5-sorting-pagination-and-source-filtering"
id="toc-exercise-5.5-sorting-pagination-and-source-filtering">Exercise
5.5: Sorting, Pagination, and Source Filtering</a></li>
</ul></li>
<li><a href="#part-6-aggregations" id="toc-part-6-aggregations">Part 6:
Aggregations</a>
<ul>
<li><a href="#exercise-6.1-metric-aggregations-with-pipeline"
id="toc-exercise-6.1-metric-aggregations-with-pipeline">Exercise 6.1:
Metric Aggregations with Pipeline</a></li>
<li><a href="#exercise-6.2-bucket-aggregations-with-filters"
id="toc-exercise-6.2-bucket-aggregations-with-filters">Exercise 6.2:
Bucket Aggregations with Filters</a></li>
<li><a href="#exercise-6.3-nested-aggregations-and-post-filters"
id="toc-exercise-6.3-nested-aggregations-and-post-filters">Exercise 6.3:
Nested Aggregations and Post-Filters</a></li>
</ul></li>
<li><a href="#part-7-ingest-pipelines"
id="toc-part-7-ingest-pipelines">Part 7: Ingest Pipelines</a>
<ul>
<li><a href="#exercise-7.1-multi-processor-pipeline"
id="toc-exercise-7.1-multi-processor-pipeline">Exercise 7.1:
Multi-Processor Pipeline</a></li>
<li><a href="#exercise-7.2-grok-and-dissect-processors"
id="toc-exercise-7.2-grok-and-dissect-processors">Exercise 7.2: Grok and
Dissect Processors</a></li>
<li><a href="#exercise-7.3-enrichment-and-lookup"
id="toc-exercise-7.3-enrichment-and-lookup">Exercise 7.3: Enrichment and
Lookup</a></li>
</ul></li>
<li><a href="#part-8-data-retention-and-ilm"
id="toc-part-8-data-retention-and-ilm">Part 8: Data Retention and
ILM</a>
<ul>
<li><a href="#exercise-8.1-complete-ilm-policy"
id="toc-exercise-8.1-complete-ilm-policy">Exercise 8.1: Complete ILM
Policy</a></li>
<li><a href="#exercise-8.2-data-streams-with-rollover"
id="toc-exercise-8.2-data-streams-with-rollover">Exercise 8.2: Data
Streams with Rollover</a></li>
<li><a href="#exercise-8.3-index-optimization-operations"
id="toc-exercise-8.3-index-optimization-operations">Exercise 8.3: Index
Optimization Operations</a></li>
</ul></li>
<li><a href="#part-9-operating-and-troubleshooting"
id="toc-part-9-operating-and-troubleshooting">Part 9: Operating and
Troubleshooting</a>
<ul>
<li><a href="#exercise-9.1-comprehensive-cluster-diagnostics"
id="toc-exercise-9.1-comprehensive-cluster-diagnostics">Exercise 9.1:
Comprehensive Cluster Diagnostics</a></li>
<li><a href="#exercise-9.2-jvm-and-memory-deep-dive"
id="toc-exercise-9.2-jvm-and-memory-deep-dive">Exercise 9.2: JVM and
Memory Deep Dive</a></li>
<li><a href="#exercise-9.3-query-performance-analysis"
id="toc-exercise-9.3-query-performance-analysis">Exercise 9.3: Query
Performance Analysis</a></li>
</ul></li>
<li><a href="#part-10-cluster-audit" id="toc-part-10-cluster-audit">Part
10: Cluster Audit</a>
<ul>
<li><a href="#exercise-10.1-production-readiness-audit"
id="toc-exercise-10.1-production-readiness-audit">Exercise 10.1:
Production Readiness Audit</a></li>
<li><a href="#exercise-10.2-security-and-best-practices-audit"
id="toc-exercise-10.2-security-and-best-practices-audit">Exercise 10.2:
Security and Best Practices Audit</a></li>
</ul></li>
<li><a href="#part-11-monitoring-with-elastic-stack"
id="toc-part-11-monitoring-with-elastic-stack">Part 11: Monitoring with
Elastic Stack</a>
<ul>
<li><a href="#exercise-11.1-metricbeat-setup-and-configuration"
id="toc-exercise-11.1-metricbeat-setup-and-configuration">Exercise 11.1:
Metricbeat Setup and Configuration</a></li>
<li><a href="#exercise-11.2-stack-monitoring-with-self-monitoring"
id="toc-exercise-11.2-stack-monitoring-with-self-monitoring">Exercise
11.2: Stack Monitoring with Self-Monitoring</a></li>
<li><a href="#exercise-11.3-custom-monitoring-queries"
id="toc-exercise-11.3-custom-monitoring-queries">Exercise 11.3: Custom
Monitoring Queries</a></li>
</ul></li>
<li><a href="#part-12-alerting-with-watcher"
id="toc-part-12-alerting-with-watcher">Part 12: Alerting with
Watcher</a>
<ul>
<li><a href="#exercise-12.1-basic-watcher-alert"
id="toc-exercise-12.1-basic-watcher-alert">Exercise 12.1: Basic Watcher
Alert</a></li>
<li><a href="#exercise-12.2-advanced-alerting-with-conditions"
id="toc-exercise-12.2-advanced-alerting-with-conditions">Exercise 12.2:
Advanced Alerting with Conditions</a></li>
<li><a href="#exercise-12.3-alerting-best-practices"
id="toc-exercise-12.3-alerting-best-practices">Exercise 12.3: Alerting
Best Practices</a></li>
</ul></li>
<li><a href="#part-13-security" id="toc-part-13-security">Part 13:
Security</a>
<ul>
<li><a href="#exercise-13.1-user-and-role-management"
id="toc-exercise-13.1-user-and-role-management">Exercise 13.1: User and
Role Management</a></li>
<li><a href="#exercise-13.2-api-keys-and-service-accounts"
id="toc-exercise-13.2-api-keys-and-service-accounts">Exercise 13.2: API
Keys and Service Accounts</a></li>
<li><a href="#exercise-13.3-audit-logging"
id="toc-exercise-13.3-audit-logging">Exercise 13.3: Audit
Logging</a></li>
</ul></li>
<li><a href="#part-14-apm-application-performance-monitoring"
id="toc-part-14-apm-application-performance-monitoring">Part 14: APM
(Application Performance Monitoring)</a>
<ul>
<li><a href="#exercise-14.1-apm-data-exploration"
id="toc-exercise-14.1-apm-data-exploration">Exercise 14.1: APM Data
Exploration</a></li>
<li><a href="#exercise-14.2-distributed-tracing-analysis"
id="toc-exercise-14.2-distributed-tracing-analysis">Exercise 14.2:
Distributed Tracing Analysis</a></li>
<li><a href="#exercise-14.3-custom-apm-metrics-and-analysis"
id="toc-exercise-14.3-custom-apm-metrics-and-analysis">Exercise 14.3:
Custom APM Metrics and Analysis</a></li>
</ul></li>
<li><a href="#cleanup" id="toc-cleanup">Cleanup</a>
<ul>
<li><a href="#remove-all-test-indices-and-resources"
id="toc-remove-all-test-indices-and-resources">Remove All Test Indices
and Resources</a></li>
</ul></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul>
</nav>
<h1
id="elasticsearch-parkki-training---practical-exercises">Elasticsearch
Parkki Training - Practical Exercises</h1>
<h2 id="overview">Overview</h2>
<p>Each exercise is <strong>autonomous</strong> - you can complete them
in any order without dependencies on other exercises.</p>
<p>All exercises use the Kibana Dev Tools console. Access it at:
<code>http://localhost:5601/app/dev_tools#/console</code></p>
<hr />
<h1 id="part-2-installation-and-configuration">Part 2: Installation and
Configuration</h1>
<h2
id="exercise-2.1-starting-elasticsearch-and-kibana---local-installation">Exercise
2.1: Starting Elasticsearch and Kibana - Local Installation</h2>
<p><strong>Objective</strong>: Install and start Elasticsearch and
Kibana locally, then verify they’re running correctly.</p>
<h3 id="step-1-install-and-start-elasticsearch">Step 1: Install and
Start Elasticsearch</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and extract Elasticsearch</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.0-linux-x86_64.tar.gz</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> elasticsearch-9.0.0-linux-x86_64.tar.gz</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> elasticsearch-9.0.0</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure Elasticsearch for single-node (edit config/elasticsearch.yml)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;discovery.type: single-node&quot;</span> <span class="op">&gt;&gt;</span> config/elasticsearch.yml</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;xpack.security.enabled: false&quot;</span> <span class="op">&gt;&gt;</span> config/elasticsearch.yml</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Elasticsearch (in the background or in a separate terminal)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ex">./bin/elasticsearch</span></span></code></pre></div>
<p><strong>Note</strong>: Keep this terminal open or run in background.
Elasticsearch will start on port 9200.</p>
<h3 id="step-2-install-and-start-kibana">Step 2: Install and Start
Kibana</h3>
<p>Open a <strong>new terminal</strong> window:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and extract Kibana</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://artifacts.elastic.co/downloads/kibana/kibana-9.0.0-linux-x86_64.tar.gz</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> kibana-9.0.0-linux-x86_64.tar.gz</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> kibana-9.0.0</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure Kibana to connect to Elasticsearch (edit config/kibana.yml)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;elasticsearch.hosts: [&#39;http://localhost:9200&#39;]&quot;</span> <span class="op">&gt;&gt;</span> config/kibana.yml</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Kibana</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ex">./bin/kibana</span></span></code></pre></div>
<p><strong>Note</strong>: Kibana will start on port 5601. Wait 1-2
minutes for full startup.</p>
<h3 id="step-3-verify-installation">Step 3: Verify Installation</h3>
<p><strong>Check Elasticsearch is running:</strong></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In a new terminal, check Elasticsearch</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:9200</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You should see JSON output with cluster info and version 9.0.0</span></span></code></pre></div>
<p><strong>Check Kibana is running:</strong></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check Kibana status</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:5601/api/status</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or simply open in browser</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># http://localhost:5601</span></span></code></pre></div>
<p>Wait 30-60 seconds for full startup, then open Kibana Dev Tools:
<code>http://localhost:5601/app/dev_tools#/console</code></p>
<p><strong>In Kibana Dev Tools, run:</strong></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check Elasticsearch is responding</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check cluster health</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/health</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># List all nodes</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/nodes<span class="pp">?</span>v</span></code></pre></div>
<p><strong>Expected Results</strong>: - Elasticsearch responds on port
9200 - Kibana interface is accessible on port 5601 - Cluster status
should be <code>green</code> or <code>yellow</code> - At least one node
should be listed - Version should be 9.x</p>
<h3 id="step-4-explore-cluster-information">Step 4: Explore Cluster
Information</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get detailed cluster info</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/health<span class="pp">?</span>level=indices</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check cluster UUID and name</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/state<span class="pp">?</span>filter_path=cluster_name,cluster_uuid</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># View cluster settings</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">flat_settings</span><span class="op">=</span>true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span>defaults.cluster.name</span></code></pre></div>
<p><strong>Challenge</strong>: What is your cluster’s UUID? What is the
default cluster name?</p>
<hr />
<h2 id="exercise-2.2-node-configuration-analysis">Exercise 2.2: Node
Configuration Analysis</h2>
<p><strong>Objective</strong>: Understand your node configuration and
identify potential issues.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Get detailed node information:</li>
</ol>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.name,nodes.<span class="pp">*</span>.roles,nodes.<span class="pp">*</span>.jvm.mem,nodes.<span class="pp">*</span>.os.name</span></code></pre></div>
<ol start="2" type="1">
<li>Check current settings:</li>
</ol>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span>defaults.cluster.routing</span></code></pre></div>
<ol start="3" type="1">
<li>Analyze JVM configuration:</li>
</ol>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/jvm<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.jvm.mem.heap_used_percent,nodes.<span class="pp">*</span>.jvm.mem.heap_max_in_bytes</span></code></pre></div>
<ol start="4" type="1">
<li>Check thread pools:</li>
</ol>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/thread_pool<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>node_name,name,active,queue,rejected,completed</span></code></pre></div>
<hr />
<h1 id="part-3-indexing">Part 3: Indexing</h1>
<h2
id="exercise-3.1-create-and-index-documents-with-validation">Exercise
3.1: Create and Index Documents with Validation</h2>
<p><strong>Objective</strong>: Practice document indexing with error
handling and validation.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create an index with specific settings:</li>
</ol>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /products</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;refresh_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;5s&quot;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Index documents with explicit IDs:</li>
</ol>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /products/_doc/1</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking Sensor&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;category&quot;</span><span class="ex">:</span> <span class="st">&quot;electronics&quot;</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;price&quot;</span><span class="ex">:</span> 29.99,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;in_stock&quot;</span><span class="ex">:</span> true,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;tags&quot;</span><span class="ex">:</span> [<span class="st">&quot;sensor&quot;</span>, <span class="st">&quot;iot&quot;</span>, <span class="st">&quot;parking&quot;</span>],</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;created_at&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /products/_doc/2</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking Barrier&quot;</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;category&quot;</span><span class="ex">:</span> <span class="st">&quot;hardware&quot;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;price&quot;</span><span class="ex">:</span> 199.99,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;in_stock&quot;</span><span class="ex">:</span> true,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;tags&quot;</span><span class="ex">:</span> [<span class="st">&quot;barrier&quot;</span>, <span class="st">&quot;access-control&quot;</span>],</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;created_at&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T11:00:00Z&quot;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /products/_doc/3</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Access Card Reader&quot;</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;category&quot;</span><span class="ex">:</span> <span class="st">&quot;electronics&quot;</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;price&quot;</span><span class="ex">:</span> 89.99,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;in_stock&quot;</span><span class="ex">:</span> false,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;tags&quot;</span><span class="ex">:</span> [<span class="st">&quot;rfid&quot;</span>, <span class="st">&quot;access-control&quot;</span>],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;created_at&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-14T09:00:00Z&quot;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Verify document count and check auto-generated mapping:</li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /products/_count</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /products/_mapping</span></code></pre></div>
<ol start="4" type="1">
<li>Retrieve a specific document:</li>
</ol>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /products/_doc/1</span></code></pre></div>
<ol start="5" type="1">
<li>Check if a document exists (without fetching it):</li>
</ol>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">HEAD</span> /products/_doc/1</span></code></pre></div>
<p><strong>Challenge</strong>: - What type did Elasticsearch assign to
the <code>price</code> field? - What type was assigned to
<code>tags</code>? - Try indexing a document with
<code>price: "not a number"</code> - what happens?</p>
<hr />
<h2 id="exercise-3.2-bulk-indexing-with-error-analysis">Exercise 3.2:
Bulk Indexing with Error Analysis</h2>
<p><strong>Objective</strong>: Practice efficient bulk indexing and
understand error handling.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Use the Bulk API to index multiple documents:</li>
</ol>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;1&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;INFO&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;User logged in&quot;</span><span class="op">,</span><span class="st">&quot;user_id&quot;</span><span class="dt">:</span><span class="st">&quot;user123&quot;</span><span class="op">,</span><span class="st">&quot;response_time_ms&quot;</span><span class="dt">:45}</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;2&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:05Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;INFO&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Parking spot reserved&quot;</span><span class="op">,</span><span class="st">&quot;user_id&quot;</span><span class="dt">:</span><span class="st">&quot;user123&quot;</span><span class="op">,</span><span class="st">&quot;spot_id&quot;</span><span class="dt">:</span><span class="st">&quot;A15&quot;</span><span class="op">,</span><span class="st">&quot;response_time_ms&quot;</span><span class="dt">:120}</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;3&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:10Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;ERROR&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;payment-service&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Payment failed&quot;</span><span class="op">,</span><span class="st">&quot;user_id&quot;</span><span class="dt">:</span><span class="st">&quot;user456&quot;</span><span class="op">,</span><span class="st">&quot;error_code&quot;</span><span class="dt">:</span><span class="st">&quot;CARD_DECLINED&quot;</span><span class="op">,</span><span class="st">&quot;response_time_ms&quot;</span><span class="dt">:2500}</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;4&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:15Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;WARN&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Spot almost full&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;parking-central&quot;</span><span class="op">,</span><span class="st">&quot;occupancy_percent&quot;</span><span class="dt">:95}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;5&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:20Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;INFO&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;notification-service&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Email sent&quot;</span><span class="op">,</span><span class="st">&quot;user_id&quot;</span><span class="dt">:</span><span class="st">&quot;user123&quot;</span><span class="op">,</span><span class="st">&quot;response_time_ms&quot;</span><span class="dt">:350}</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;6&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:25Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;DEBUG&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Cache hit for parking status&quot;</span><span class="op">,</span><span class="st">&quot;cache_key&quot;</span><span class="dt">:</span><span class="st">&quot;parking-central-status&quot;</span><span class="dt">}</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;7&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:30Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;ERROR&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;Database connection timeout&quot;</span><span class="op">,</span><span class="st">&quot;error_code&quot;</span><span class="dt">:</span><span class="st">&quot;DB_TIMEOUT&quot;</span><span class="op">,</span><span class="st">&quot;response_time_ms&quot;</span><span class="dt">:30000}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Analyze the bulk response - check for errors:</li>
</ol>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /logs-parkki/_count</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /logs-parkki/_search</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Test bulk with intentional errors:</li>
</ol>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;100&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;invalid-date&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;INFO&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;This should fail&quot;</span><span class="dt">}</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;logs-parkki&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;101&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;level&quot;</span><span class="dt">:</span><span class="st">&quot;INFO&quot;</span><span class="op">,</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;This should succeed&quot;</span><span class="dt">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - How many documents were indexed
successfully? - Did the invalid date cause the entire bulk to fail, or
just that document? - What is the average <code>response_time_ms</code>
for ERROR level logs?</p>
<hr />
<h2 id="exercise-3.3-document-operations-crud-with-concurrency">Exercise
3.3: Document Operations (CRUD) with Concurrency</h2>
<p><strong>Objective</strong>: Practice update, delete, and optimistic
concurrency control.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a reservation document:</li>
</ol>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /reservations/_doc/res001</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user123&quot;</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-central&quot;</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;A15&quot;</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;start_time&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T14:00:00Z&quot;</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;end_time&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T18:00:00Z&quot;</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;status&quot;</span><span class="ex">:</span> <span class="st">&quot;pending&quot;</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;price&quot;</span><span class="ex">:</span> 12.50,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;version&quot;</span><span class="ex">:</span> 1</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Get the document with sequence numbers (for optimistic
locking):</li>
</ol>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /reservations/_doc/res001</span></code></pre></div>
<ol start="3" type="1">
<li>Update using optimistic concurrency control:</li>
</ol>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, note the _seq_no and _primary_term from the GET response</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Then update with those values:</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /reservations/_update/res001<span class="pp">?</span>if_seq_no=0<span class="kw">&amp;</span><span class="va">if_primary_term</span><span class="op">=</span>1</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;doc&quot;</span><span class="ex">:</span> {</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;status&quot;</span><span class="ex">:</span> <span class="st">&quot;confirmed&quot;</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;confirmed_at&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:30:00Z&quot;</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;version&quot;</span><span class="ex">:</span> 2</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Update with script (atomic increment):</li>
</ol>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /reservations/_update/res001</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx._source.version += 1; ctx._source.price *= params.multiplier&quot;</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;params&quot;</span><span class="ex">:</span> {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;multiplier&quot;</span><span class="ex">:</span> 1.1</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Upsert (update or insert):</li>
</ol>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /reservations/_update/res002</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;doc&quot;</span><span class="ex">:</span> {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user456&quot;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;status&quot;</span><span class="ex">:</span> <span class="st">&quot;pending&quot;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;doc_as_upsert&quot;</span><span class="ex">:</span> true</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="6" type="1">
<li>Delete with refresh:</li>
</ol>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /reservations/_doc/res002<span class="pp">?</span>refresh=true</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify deletion</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /reservations/_doc/res002</span></code></pre></div>
<p><strong>Challenge</strong>: - What HTTP status code do you get for a
version conflict? - What is the new price after the script update (with
1.1 multiplier)? - Create a script that only updates if status is
“pending”</p>
<hr />
<h1 id="part-4-mapping">Part 4: Mapping</h1>
<h2 id="exercise-4.1-explicit-mapping-with-analyzers">Exercise 4.1:
Explicit Mapping with Analyzers</h2>
<p><strong>Objective</strong>: Create an optimized mapping for parking
logs with custom analysis.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>First, test the analyzer behavior:</li>
</ol>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_analyze</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;analyzer&quot;</span><span class="ex">:</span> <span class="st">&quot;standard&quot;</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;The user user-123 parked at PARKING-CENTRAL spot A15&quot;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_analyze</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;analyzer&quot;</span><span class="ex">:</span> <span class="st">&quot;simple&quot;</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;The user user-123 parked at PARKING-CENTRAL spot A15&quot;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create an index with explicit mapping and custom settings:</li>
</ol>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-events</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;analysis&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;analyzer&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;parking_analyzer&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;custom&quot;</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;tokenizer&quot;</span><span class="ex">:</span> <span class="st">&quot;standard&quot;</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [<span class="st">&quot;lowercase&quot;</span>, <span class="st">&quot;asciifolding&quot;</span>]</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dynamic&quot;</span><span class="ex">:</span> <span class="st">&quot;strict&quot;</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;event_type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;vehicle_plate&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;keyword&quot;</span>,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;normalizer&quot;</span><span class="ex">:</span> <span class="st">&quot;lowercase&quot;</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;duration_minutes&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;amount&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;scaled_float&quot;</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;scaling_factor&quot;</span><span class="ex">:</span> 100</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;analyzer&quot;</span><span class="ex">:</span> <span class="st">&quot;parking_analyzer&quot;</span>,</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fields&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;keyword&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span>, <span class="st">&quot;ignore_above&quot;</span>: 256 }</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;geo_point&quot;</span> },</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;metadata&quot;</span><span class="ex">:</span> {</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;object&quot;</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;enabled&quot;</span><span class="ex">:</span> false</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Verify the mapping:</li>
</ol>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-events/_mapping</span></code></pre></div>
<ol start="4" type="1">
<li>Index valid documents:</li>
</ol>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /parking-events/_doc</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T14:30:00Z&quot;</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;event_type&quot;</span><span class="ex">:</span> <span class="st">&quot;ENTRY&quot;</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-central&quot;</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;B22&quot;</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user789&quot;</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;vehicle_plate&quot;</span><span class="ex">:</span> <span class="st">&quot;AB-123-CD&quot;</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;duration_minutes&quot;</span><span class="ex">:</span> 120,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;amount&quot;</span><span class="ex">:</span> 8.50,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;description&quot;</span><span class="ex">:</span> <span class="st">&quot;Standard parking entry via mobile app with préférence&quot;</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 },</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metadata&quot;</span><span class="ex">:</span> { <span class="st">&quot;app_version&quot;</span>: <span class="st">&quot;2.1.0&quot;</span>, <span class="st">&quot;device&quot;</span>: <span class="st">&quot;iPhone&quot;</span> }</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Test strict mapping - try to add an unknown field:</li>
</ol>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /parking-events/_doc</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T15:00:00Z&quot;</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;event_type&quot;</span><span class="ex">:</span> <span class="st">&quot;EXIT&quot;</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;unknown_field&quot;</span><span class="ex">:</span> <span class="st">&quot;this should fail&quot;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - What happens when you try to index a
document with an unknown field? - Search for “preference” (without
accent) - does it find the document with “préférence”? - What is the
advantage of <code>scaled_float</code> over <code>float</code> for
monetary amounts?</p>
<hr />
<h2 id="exercise-4.2-multi-fields-and-aggregation-optimization">Exercise
4.2: Multi-fields and Aggregation Optimization</h2>
<p><strong>Objective</strong>: Use multi-fields for flexible searching
and efficient aggregations.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create an index with optimized multi-fields:</li>
</ol>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-lots</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fields&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;keyword&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;keyword&quot;</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;normalizer&quot;</span><span class="ex">:</span> <span class="st">&quot;lowercase&quot;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>          <span class="ex">},</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;autocomplete&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;search_as_you_type&quot;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;address&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fields&quot;</span><span class="ex">:</span> {</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;keyword&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;city&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;country&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;capacity&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;available_spots&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;hourly_rate&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;float&quot;</span> },</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;features&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;geo_point&quot;</span> },</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;rating&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;half_float&quot;</span> }</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Index sample data:</li>
</ol>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-lots&quot;</span><span class="ex">}}</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Central Paris&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;15 Rue de Rivoli&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;country&quot;</span><span class="dt">:</span><span class="st">&quot;France&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:500</span><span class="op">,</span><span class="st">&quot;available_spots&quot;</span><span class="dt">:123</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:4.50</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;ev_charging&quot;</span><span class="op">,</span><span class="st">&quot;handicap&quot;</span><span class="op">,</span><span class="st">&quot;covered&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8606</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3376}</span><span class="op">,</span><span class="st">&quot;rating&quot;</span><span class="dt">:4.2}</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-lots&quot;</span><span class="ex">}}</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Gare du Nord&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;18 Rue de Dunkerque&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;country&quot;</span><span class="dt">:</span><span class="st">&quot;France&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:300</span><span class="op">,</span><span class="st">&quot;available_spots&quot;</span><span class="dt">:45</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:5.00</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;covered&quot;</span><span class="op">,</span><span class="st">&quot;24h&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8809</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3553}</span><span class="op">,</span><span class="st">&quot;rating&quot;</span><span class="dt">:3.8}</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-lots&quot;</span><span class="ex">}}</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Place Bellecour&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;Place Bellecour&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Lyon&quot;</span><span class="op">,</span><span class="st">&quot;country&quot;</span><span class="dt">:</span><span class="st">&quot;France&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:400</span><span class="op">,</span><span class="st">&quot;available_spots&quot;</span><span class="dt">:200</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:3.50</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;ev_charging&quot;</span><span class="op">,</span><span class="st">&quot;covered&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:45.7578</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:4.8320}</span><span class="op">,</span><span class="st">&quot;rating&quot;</span><span class="dt">:4.5}</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-lots&quot;</span><span class="ex">}}</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Centre Commercial&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;Avenue des Champs&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Nice&quot;</span><span class="op">,</span><span class="st">&quot;country&quot;</span><span class="dt">:</span><span class="st">&quot;France&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:800</span><span class="op">,</span><span class="st">&quot;available_spots&quot;</span><span class="dt">:500</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:3.00</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;covered&quot;</span><span class="op">,</span><span class="st">&quot;free_first_hour&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:43.7102</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:7.2620}</span><span class="op">,</span><span class="st">&quot;rating&quot;</span><span class="dt">:4.0}</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-lots&quot;</span><span class="ex">}}</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;PARKING GARE LYON&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;Place Louis Armand&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;country&quot;</span><span class="dt">:</span><span class="st">&quot;France&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:600</span><span class="op">,</span><span class="st">&quot;available_spots&quot;</span><span class="dt">:89</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:6.00</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;ev_charging&quot;</span><span class="op">,</span><span class="st">&quot;24h&quot;</span><span class="op">,</span><span class="st">&quot;valet&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8448</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3735}</span><span class="op">,</span><span class="st">&quot;rating&quot;</span><span class="dt">:4.1}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Test autocomplete (search-as-you-type):</li>
</ol>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-lots/_search</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;multi_match&quot;</span><span class="ex">:</span> {</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> <span class="st">&quot;park cen&quot;</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;bool_prefix&quot;</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;fields&quot;</span><span class="ex">:</span> [<span class="st">&quot;name.autocomplete&quot;</span>, <span class="st">&quot;name.autocomplete._2gram&quot;</span>, <span class="st">&quot;name.autocomplete._3gram&quot;</span>]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Compare text vs keyword search:</li>
</ol>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Full-text search (matches partial words)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-lots/_search</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;parking gare&quot;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Exact match on normalized keyword</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-lots/_search</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> {</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name.keyword&quot;</span><span class="ex">:</span> <span class="st">&quot;parking gare lyon&quot;</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Why does “parking gare lyon”
(lowercase) match “PARKING GARE LYON”? - How many parking lots have EV
charging?</p>
<hr />
<h2 id="exercise-4.3-nested-objects-vs-flattened">Exercise 4.3: Nested
Objects vs Flattened</h2>
<p><strong>Objective</strong>: Understand when to use nested types and
their performance implications.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>First, create an index WITHOUT nested (to see the problem):</li>
</ol>
<div class="sourceCode" id="cb34"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-flat</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;spots&quot;</span><span class="ex">:</span> {</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;floor&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;available&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;boolean&quot;</span> }</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /parking-flat/_doc</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking Central&quot;</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;spots&quot;</span><span class="ex">:</span> [</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;A01&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;standard&quot;</span>, <span class="st">&quot;available&quot;</span>: true },</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;A02&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;handicap&quot;</span>, <span class="st">&quot;available&quot;</span>: false },</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;B01&quot;</span>, <span class="st">&quot;floor&quot;</span>: 2, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;standard&quot;</span>, <span class="st">&quot;available&quot;</span>: false }</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Search for “available standard spot on floor 1” (THIS IS THE
PROBLEM):</li>
</ol>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-flat/_search</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.floor&quot;</span>: 1 } },</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.type&quot;</span>: <span class="st">&quot;standard&quot;</span> } },</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.available&quot;</span>: true } }</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Now create with NESTED type:</li>
</ol>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-nested</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;spots&quot;</span><span class="ex">:</span> {</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;nested&quot;</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;floor&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;available&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;boolean&quot;</span> },</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;price_per_hour&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;float&quot;</span> }</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /parking-nested/_doc/1</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking Central&quot;</span>,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;spots&quot;</span><span class="ex">:</span> [</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;A01&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;standard&quot;</span>, <span class="st">&quot;available&quot;</span>: true, <span class="st">&quot;price_per_hour&quot;</span>: 3.0 },</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;A02&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;handicap&quot;</span>, <span class="st">&quot;available&quot;</span>: false, <span class="st">&quot;price_per_hour&quot;</span>: 2.0 },</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;B01&quot;</span>, <span class="st">&quot;floor&quot;</span>: 2, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;standard&quot;</span>, <span class="st">&quot;available&quot;</span>: false, <span class="st">&quot;price_per_hour&quot;</span>: 2.5 }</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /parking-nested/_doc/2</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking Nord&quot;</span>,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;spots&quot;</span><span class="ex">:</span> [</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;N01&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;ev_charging&quot;</span>, <span class="st">&quot;available&quot;</span>: true, <span class="st">&quot;price_per_hour&quot;</span>: 4.0 },</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> <span class="st">&quot;N02&quot;</span>, <span class="st">&quot;floor&quot;</span>: 1, <span class="st">&quot;type&quot;</span>: <span class="st">&quot;standard&quot;</span>, <span class="st">&quot;available&quot;</span>: true, <span class="st">&quot;price_per_hour&quot;</span>: 3.0 }</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Correct nested query:</li>
</ol>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-nested/_search</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;nested&quot;</span><span class="ex">:</span> {</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;path&quot;</span><span class="ex">:</span> <span class="st">&quot;spots&quot;</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.floor&quot;</span>: 1 } },</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.type&quot;</span>: <span class="st">&quot;standard&quot;</span> } },</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;spots.available&quot;</span>: true } }</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>          <span class="ex">]</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;inner_hits&quot;</span><span class="ex">:</span> {}</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Why did the flat structure query return
a result even though there’s no available standard spot on floor 1? -
What does <code>inner_hits</code> show in the nested query response?</p>
<hr />
<h2 id="exercise-4.4-index-templates-with-priority">Exercise 4.4: Index
Templates with Priority</h2>
<p><strong>Objective</strong>: Create reusable index templates with
component composition.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create component templates:</li>
</ol>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Base settings component</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_component_template/base-settings</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;refresh_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;30s&quot;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Logs mappings component</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_component_template/logs-mappings</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;level&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;fields&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;keyword&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span>, <span class="st">&quot;ignore_above&quot;</span>: 512 }</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;service&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;host&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;trace_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Parkki-specific mappings component</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_component_template/parkki-mappings</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;spot_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;transaction_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create index templates with different priorities:</li>
</ol>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># General logs template (low priority)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_index_template/logs-template</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index_patterns&quot;</span><span class="ex">:</span> [<span class="st">&quot;logs-*&quot;</span>],</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 100,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;composed_of&quot;</span><span class="ex">:</span> [<span class="st">&quot;base-settings&quot;</span>, <span class="st">&quot;logs-mappings&quot;</span>],</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;aliases&quot;</span><span class="ex">:</span> {</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logs&quot;</span><span class="ex">:</span> {}</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Parkki-specific logs template (higher priority)</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_index_template/logs-parkki-template</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index_patterns&quot;</span><span class="ex">:</span> [<span class="st">&quot;logs-parkki-*&quot;</span>],</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 200,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;composed_of&quot;</span><span class="ex">:</span> [<span class="st">&quot;base-settings&quot;</span>, <span class="st">&quot;logs-mappings&quot;</span>, <span class="st">&quot;parkki-mappings&quot;</span>],</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;index.lifecycle.name&quot;</span><span class="ex">:</span> <span class="st">&quot;logs-lifecycle&quot;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;aliases&quot;</span><span class="ex">:</span> {</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logs&quot;</span><span class="ex">:</span> {},</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;parkki-logs&quot;</span><span class="ex">:</span> {}</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Create indices and verify templates are applied:</li>
</ol>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a general log index</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /logs-nginx-2025.01.15</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Parkki log index</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /logs-parkki-api-2025.01.15</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify mappings</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /logs-nginx-2025.01.15/_mapping</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /logs-parkki-api-2025.01.15/_mapping</span></code></pre></div>
<ol start="4" type="1">
<li>Check which template was applied:</li>
</ol>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_index_template/logs-<span class="pp">*</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate which template would match</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_index_template/_simulate_index/logs-parkki-test</span></code></pre></div>
<ol start="5" type="1">
<li>Index documents and verify aliases:</li>
</ol>
<div class="sourceCode" id="cb42"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /logs-parkki-api-2025.01.15/_doc</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;INFO&quot;</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;User reservation completed&quot;</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;service&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-api&quot;</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;central&quot;</span>,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user123&quot;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Search via alias</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parkki-logs/_search</span></code></pre></div>
<p><strong>Challenge</strong>: - Which template is applied to
<code>logs-parkki-api-2025.01.15</code>? How do you know? - Does
<code>logs-nginx-2025.01.15</code> have the <code>parking_id</code>
field in its mapping? - What happens if you create
<code>logs-other-2025.01.15</code>?</p>
<hr />
<h1 id="part-5-search">Part 5: Search</h1>
<h2 id="exercise-5.1-full-text-search-with-relevance-tuning">Exercise
5.1: Full-Text Search with Relevance Tuning</h2>
<p><strong>Objective</strong>: Practice full-text search queries and
understand scoring.</p>
<p><strong>Setup</strong>: Create and populate a test index:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /articles</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;title&quot;</span><span class="ex">:</span> {</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;text&quot;</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fields&quot;</span><span class="ex">:</span> { <span class="st">&quot;keyword&quot;</span>: { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> } }</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;text&quot;</span> },</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;summary&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;text&quot;</span> },</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;author&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;category&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;tags&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;published_at&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;views&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> }</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;articles&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;1&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;title&quot;</span><span class="dt">:</span><span class="st">&quot;Smart Parking Solutions for Modern Cities&quot;</span><span class="op">,</span><span class="st">&quot;content&quot;</span><span class="dt">:</span><span class="st">&quot;Urban parking management is evolving with IoT sensors and mobile applications. Smart parking reduces congestion and emissions by helping drivers find available spots quickly. The technology uses real-time data to optimize parking space utilization.&quot;</span><span class="op">,</span><span class="st">&quot;summary&quot;</span><span class="dt">:</span><span class="st">&quot;How IoT is transforming urban parking&quot;</span><span class="op">,</span><span class="st">&quot;author&quot;</span><span class="dt">:</span><span class="st">&quot;John Smith&quot;</span><span class="op">,</span><span class="st">&quot;category&quot;</span><span class="dt">:</span><span class="st">&quot;technology&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;iot&quot;</span><span class="op">,</span><span class="st">&quot;smart-city&quot;</span><span class="op">,</span><span class="st">&quot;parking&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;published_at&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-10&quot;</span><span class="op">,</span><span class="st">&quot;views&quot;</span><span class="dt">:1520}</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;articles&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;2&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;title&quot;</span><span class="dt">:</span><span class="st">&quot;The Future of Electric Vehicle Charging&quot;</span><span class="op">,</span><span class="st">&quot;content&quot;</span><span class="dt">:</span><span class="st">&quot;Electric vehicles need dedicated parking spots with charging stations. Smart cities are adapting their parking infrastructure to accommodate the growing EV market. Parking operators are investing in fast-charging technology.&quot;</span><span class="op">,</span><span class="st">&quot;summary&quot;</span><span class="dt">:</span><span class="st">&quot;EV charging infrastructure in parking facilities&quot;</span><span class="op">,</span><span class="st">&quot;author&quot;</span><span class="dt">:</span><span class="st">&quot;Jane Doe&quot;</span><span class="op">,</span><span class="st">&quot;category&quot;</span><span class="dt">:</span><span class="st">&quot;sustainability&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;ev&quot;</span><span class="op">,</span><span class="st">&quot;charging&quot;</span><span class="op">,</span><span class="st">&quot;parking&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;published_at&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-12&quot;</span><span class="op">,</span><span class="st">&quot;views&quot;</span><span class="dt">:2340}</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;articles&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;3&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;title&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Revenue Optimization Strategies&quot;</span><span class="op">,</span><span class="st">&quot;content&quot;</span><span class="dt">:</span><span class="st">&quot;Dynamic pricing and real-time availability can increase parking revenue by 30%. Mobile payment integration is key for modern parking operations. Data analytics helps identify peak hours and optimize pricing.&quot;</span><span class="op">,</span><span class="st">&quot;summary&quot;</span><span class="dt">:</span><span class="st">&quot;Maximize parking business revenue&quot;</span><span class="op">,</span><span class="st">&quot;author&quot;</span><span class="dt">:</span><span class="st">&quot;John Smith&quot;</span><span class="op">,</span><span class="st">&quot;category&quot;</span><span class="dt">:</span><span class="st">&quot;business&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;revenue&quot;</span><span class="op">,</span><span class="st">&quot;pricing&quot;</span><span class="op">,</span><span class="st">&quot;analytics&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;published_at&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-14&quot;</span><span class="op">,</span><span class="st">&quot;views&quot;</span><span class="dt">:890}</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;articles&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;4&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;title&quot;</span><span class="dt">:</span><span class="st">&quot;Autonomous Vehicles and Parking Design&quot;</span><span class="op">,</span><span class="st">&quot;content&quot;</span><span class="dt">:</span><span class="st">&quot;Self-driving cars will revolutionize parking lot design. Autonomous vehicles can park themselves more efficiently, requiring less space. Future parking structures may look very different from today.&quot;</span><span class="op">,</span><span class="st">&quot;summary&quot;</span><span class="dt">:</span><span class="st">&quot;How AVs will change parking architecture&quot;</span><span class="op">,</span><span class="st">&quot;author&quot;</span><span class="dt">:</span><span class="st">&quot;Alex Johnson&quot;</span><span class="op">,</span><span class="st">&quot;category&quot;</span><span class="dt">:</span><span class="st">&quot;technology&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;autonomous&quot;</span><span class="op">,</span><span class="st">&quot;future&quot;</span><span class="op">,</span><span class="st">&quot;design&quot;</span><span class="dt">]</span><span class="op">,</span><span class="st">&quot;published_at&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15&quot;</span><span class="op">,</span><span class="st">&quot;views&quot;</span><span class="dt">:3100}</span></span></code></pre></div>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Simple match query with score explanation:</li>
</ol>
<div class="sourceCode" id="cb44"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;explain&quot;</span><span class="ex">:</span> true,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> <span class="st">&quot;parking mobile&quot;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Match with operator control:</li>
</ol>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Must match ALL terms</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span><span class="ex">:</span> <span class="st">&quot;parking mobile&quot;</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;operator&quot;</span><span class="ex">:</span> <span class="st">&quot;and&quot;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Must match at least 2 terms</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> {</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span><span class="ex">:</span> <span class="st">&quot;parking mobile charging&quot;</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;minimum_should_match&quot;</span><span class="ex">:</span> 2</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Multi-match with field boosting:</li>
</ol>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;multi_match&quot;</span><span class="ex">:</span> {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> <span class="st">&quot;smart parking&quot;</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;fields&quot;</span><span class="ex">:</span> [<span class="st">&quot;title^3&quot;</span>, <span class="st">&quot;summary^2&quot;</span>, <span class="st">&quot;content&quot;</span>],</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;best_fields&quot;</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;tie_breaker&quot;</span><span class="ex">:</span> 0.3</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Phrase matching with slop:</li>
</ol>
<div class="sourceCode" id="cb47"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exact phrase</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match_phrase&quot;</span><span class="ex">:</span> {</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> <span class="st">&quot;parking management&quot;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Allow words between</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match_phrase&quot;</span><span class="ex">:</span> {</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> {</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span><span class="ex">:</span> <span class="st">&quot;parking technology&quot;</span>,</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;slop&quot;</span><span class="ex">:</span> 5</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Function score to boost by popularity:</li>
</ol>
<div class="sourceCode" id="cb48"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;function_score&quot;</span><span class="ex">:</span> {</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;parking&quot;</span> }</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;functions&quot;</span><span class="ex">:</span> [</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;field_value_factor&quot;</span><span class="ex">:</span> {</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;views&quot;</span>,</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;factor&quot;</span><span class="ex">:</span> 0.0001,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;modifier&quot;</span><span class="ex">:</span> <span class="st">&quot;log1p&quot;</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;boost_mode&quot;</span><span class="ex">:</span> <span class="st">&quot;multiply&quot;</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Which article has the highest score for
“parking mobile”? Why? - How does the <code>tie_breaker</code> affect
multi_match results? - Boost articles from “John Smith” by 2x using a
function score</p>
<hr />
<h2 id="exercise-5.2-term-level-and-range-queries">Exercise 5.2:
Term-Level and Range Queries</h2>
<p><strong>Objective</strong>: Practice exact matching, ranges, and
existence queries.</p>
<p><strong>Setup</strong>: Use the <code>articles</code> index from
Exercise 5.1.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Term query with case sensitivity awareness:</li>
</ol>
<div class="sourceCode" id="cb49"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This works (keyword field)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;author&quot;</span><span class="ex">:</span> <span class="st">&quot;John Smith&quot;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This might not work as expected on text field</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;title&quot;</span><span class="ex">:</span> <span class="st">&quot;Smart&quot;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Use keyword sub-field for exact match</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> {</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;title.keyword&quot;</span><span class="ex">:</span> <span class="st">&quot;Smart Parking Solutions for Modern Cities&quot;</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Terms query with minimum match:</li>
</ol>
<div class="sourceCode" id="cb50"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;terms&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;tags&quot;</span><span class="ex">:</span> [<span class="st">&quot;parking&quot;</span>, <span class="st">&quot;iot&quot;</span>, <span class="st">&quot;ev&quot;</span>]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># With terms_set for minimum matching</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;terms_set&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;tags&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;terms&quot;</span><span class="ex">:</span> [<span class="st">&quot;parking&quot;</span>, <span class="st">&quot;iot&quot;</span>, <span class="st">&quot;ev&quot;</span>],</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;minimum_should_match_script&quot;</span><span class="ex">:</span> {</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;2&quot;</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Range queries with different bounds:</li>
</ol>
<div class="sourceCode" id="cb51"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Date range</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;published_at&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;gte&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-11&quot;</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;lt&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15&quot;</span>,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;format&quot;</span><span class="ex">:</span> <span class="st">&quot;yyyy-MM-dd&quot;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Numeric range with boost</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;views&quot;</span><span class="ex">:</span> {</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;gte&quot;</span><span class="ex">:</span> 1000,</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;boost&quot;</span><span class="ex">:</span> 2.0</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Exists and missing:</li>
</ol>
<div class="sourceCode" id="cb52"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Documents with tags</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;exists&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;tags&quot;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Documents without a specific field (must_not exists)</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must_not&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;exists&quot;</span><span class="ex">:</span> {</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;deleted_at&quot;</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Prefix and wildcard:</li>
</ol>
<div class="sourceCode" id="cb53"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prefix query</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;prefix&quot;</span><span class="ex">:</span> {</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;category&quot;</span><span class="ex">:</span> <span class="st">&quot;tech&quot;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Wildcard (use sparingly!)</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;wildcard&quot;</span><span class="ex">:</span> {</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;author&quot;</span><span class="ex">:</span> <span class="st">&quot;*Smith&quot;</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Why does <code>term</code> on the
<code>title</code> field not find “Smart” but works on
<code>author</code>? - Find all articles with more than 1500 views
published after January 12th - Which articles have at least 2 of these
tags: parking, iot, ev?</p>
<hr />
<h2 id="exercise-5.3-boolean-queries-with-scoring-control">Exercise 5.3:
Boolean Queries with Scoring Control</h2>
<p><strong>Objective</strong>: Master complex boolean queries and
understand scoring contexts.</p>
<p><strong>Setup</strong>: Use the <code>articles</code> index.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Bool query with all clauses:</li>
</ol>
<div class="sourceCode" id="cb54"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;parking&quot;</span> } }</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;should&quot;</span><span class="ex">:</span> [</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;technology&quot;</span> } },</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;sustainability&quot;</span> } },</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;views&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 2000 } } }</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must_not&quot;</span><span class="ex">:</span> [</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;author&quot;</span>: <span class="st">&quot;Alex Johnson&quot;</span> } }</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;published_at&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;2025-01-01&quot;</span> } } },</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;exists&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;tags&quot;</span> } }</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;minimum_should_match&quot;</span><span class="ex">:</span> 1</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Understand filter vs query context:</li>
</ol>
<div class="sourceCode" id="cb55"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This query scores based on views</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;views&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 1000 } } }</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This filter does NOT affect score</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;views&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 1000 } } }</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Nested bool queries:</li>
</ol>
<div class="sourceCode" id="cb56"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;parking&quot;</span> } }</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;should&quot;</span><span class="ex">:</span> [</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>              <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;technology&quot;</span> } },</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>              <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;views&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 1500 } } }</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>            <span class="ex">]</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>              <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;sustainability&quot;</span> } },</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>              <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;author&quot;</span>: <span class="st">&quot;Jane Doe&quot;</span> } }</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>            <span class="ex">]</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;minimum_should_match&quot;</span><span class="ex">:</span> 1</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Boosting query (positive and negative):</li>
</ol>
<div class="sourceCode" id="cb57"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;boosting&quot;</span><span class="ex">:</span> {</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;positive&quot;</span><span class="ex">:</span> {</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;parking&quot;</span> }</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;negative&quot;</span><span class="ex">:</span> {</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;business&quot;</span> }</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;negative_boost&quot;</span><span class="ex">:</span> 0.5</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - What’s the score difference between
filter and query context for the same range query? - Build a query:
articles about parking, preferably technology OR sustainability
category, excluding business, from 2025 - How would you give technology
articles double the score of sustainability articles?</p>
<hr />
<h2 id="exercise-5.4-geo-queries-and-distance-calculations">Exercise
5.4: Geo Queries and Distance Calculations</h2>
<p><strong>Objective</strong>: Practice geographical searches with
complex constraints.</p>
<p><strong>Setup</strong>: Create a geo-enabled index:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-locations</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;geo_point&quot;</span> },</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;coverage_area&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;geo_shape&quot;</span> },</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;capacity&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;available&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;hourly_rate&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;float&quot;</span> },</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;features&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-locations&quot;</span><span class="ex">}}</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Opera&quot;</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8719</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3316}</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:200</span><span class="op">,</span><span class="st">&quot;available&quot;</span><span class="dt">:45</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:5.50</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;covered&quot;</span><span class="op">,</span><span class="st">&quot;ev_charging&quot;</span><span class="dt">]}</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-locations&quot;</span><span class="ex">}}</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Louvre&quot;</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8606</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3376}</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:500</span><span class="op">,</span><span class="st">&quot;available&quot;</span><span class="dt">:120</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:6.00</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;covered&quot;</span><span class="op">,</span><span class="st">&quot;24h&quot;</span><span class="op">,</span><span class="st">&quot;valet&quot;</span><span class="dt">]}</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-locations&quot;</span><span class="ex">}}</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Bastille&quot;</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8534</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3691}</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:300</span><span class="op">,</span><span class="st">&quot;available&quot;</span><span class="dt">:80</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:4.00</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;outdoor&quot;</span><span class="op">,</span><span class="st">&quot;motorcycle&quot;</span><span class="dt">]}</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-locations&quot;</span><span class="ex">}}</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Montmartre&quot;</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8867</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3431}</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:150</span><span class="op">,</span><span class="st">&quot;available&quot;</span><span class="dt">:10</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:4.50</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;covered&quot;</span><span class="dt">]}</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parking-locations&quot;</span><span class="ex">}}</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Nation&quot;</span><span class="op">,</span><span class="st">&quot;location&quot;</span><span class="dt">:{</span><span class="st">&quot;lat&quot;</span><span class="dt">:48.8483</span><span class="op">,</span><span class="st">&quot;lon&quot;</span><span class="dt">:2.3959}</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:400</span><span class="op">,</span><span class="st">&quot;available&quot;</span><span class="dt">:200</span><span class="op">,</span><span class="st">&quot;hourly_rate&quot;</span><span class="dt">:3.50</span><span class="op">,</span><span class="st">&quot;features&quot;</span><span class="dt">:[</span><span class="st">&quot;outdoor&quot;</span><span class="op">,</span><span class="st">&quot;large_vehicles&quot;</span><span class="dt">]}</span></span></code></pre></div>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Find parking within distance:</li>
</ol>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-locations/_search</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;distance&quot;</span><span class="ex">:</span> <span class="st">&quot;2km&quot;</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;location&quot;</span><span class="ex">:</span> {</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;lat&quot;</span><span class="ex">:</span> 48.8566,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;lon&quot;</span><span class="ex">:</span> 2.3522</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Sort by distance with calculated distance in results:</li>
</ol>
<div class="sourceCode" id="cb60"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-locations/_search</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;distance&quot;</span><span class="ex">:</span> <span class="st">&quot;5km&quot;</span>,</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 }</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 },</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;order&quot;</span><span class="ex">:</span> <span class="st">&quot;asc&quot;</span>,</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;unit&quot;</span><span class="ex">:</span> <span class="st">&quot;m&quot;</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>  <span class="ex">],</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;script_fields&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;distance_km&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;doc[&#39;location&#39;].arcDistance(params.lat, params.lon) / 1000&quot;</span>,</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;params&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 }</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Geo bounding box:</li>
</ol>
<div class="sourceCode" id="cb61"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-locations/_search</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;geo_bounding_box&quot;</span><span class="ex">:</span> {</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;location&quot;</span><span class="ex">:</span> {</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;top_left&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.88, <span class="st">&quot;lon&quot;</span>: 2.32 },</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;bottom_right&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.85, <span class="st">&quot;lon&quot;</span>: 2.38 }</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Combine geo with other filters:</li>
</ol>
<div class="sourceCode" id="cb62"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-locations/_search</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;distance&quot;</span><span class="ex">:</span> <span class="st">&quot;3km&quot;</span>,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 }</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;available&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 20 } } },</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;hourly_rate&quot;</span>: { <span class="st">&quot;lte&quot;</span>: 5.0 } } },</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;features&quot;</span>: <span class="st">&quot;covered&quot;</span> } }</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;hourly_rate&quot;</span><span class="ex">:</span> <span class="st">&quot;asc&quot;</span> },</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;location&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 },</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;order&quot;</span><span class="ex">:</span> <span class="st">&quot;asc&quot;</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Geo aggregation:</li>
</ol>
<div class="sourceCode" id="cb63"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parking-locations/_search</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;distance_rings&quot;</span><span class="ex">:</span> {</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;geo_distance&quot;</span><span class="ex">:</span> {</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;location&quot;</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;origin&quot;</span><span class="ex">:</span> { <span class="st">&quot;lat&quot;</span>: 48.8566, <span class="st">&quot;lon&quot;</span>: 2.3522 },</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;unit&quot;</span><span class="ex">:</span> <span class="st">&quot;km&quot;</span>,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ranges&quot;</span><span class="ex">:</span> [</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;nearby&quot;</span>, <span class="st">&quot;to&quot;</span>: 1 },</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;walking&quot;</span>, <span class="st">&quot;from&quot;</span>: 1, <span class="st">&quot;to&quot;</span>: 2 },</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;driving&quot;</span>, <span class="st">&quot;from&quot;</span>: 2, <span class="st">&quot;to&quot;</span>: 5 }</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;total_capacity&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;capacity&quot;</span> } },</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;total_available&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;available&quot;</span> } }</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Find the closest covered parking with
EV charging to the Louvre (48.8606, 2.3376) - What’s the total available
capacity within 2km of city center? - Find parking that’s cheap
(&lt;4€), has spots available (&gt;50), and is within 3km</p>
<hr />
<h2 id="exercise-5.5-sorting-pagination-and-source-filtering">Exercise
5.5: Sorting, Pagination, and Source Filtering</h2>
<p><strong>Objective</strong>: Master result ordering and efficient
pagination.</p>
<p><strong>Setup</strong>: Use the <code>articles</code> and
<code>parking-locations</code> indices.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Multi-field sorting:</li>
</ol>
<div class="sourceCode" id="cb64"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;category&quot;</span><span class="ex">:</span> { <span class="st">&quot;order&quot;</span>: <span class="st">&quot;asc&quot;</span> } },</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;views&quot;</span><span class="ex">:</span> { <span class="st">&quot;order&quot;</span>: <span class="st">&quot;desc&quot;</span> } },</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;published_at&quot;</span><span class="ex">:</span> { <span class="st">&quot;order&quot;</span>: <span class="st">&quot;desc&quot;</span> } }</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Sorting with missing values:</li>
</ol>
<div class="sourceCode" id="cb65"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;views&quot;</span><span class="ex">:</span> {</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;order&quot;</span><span class="ex">:</span> <span class="st">&quot;desc&quot;</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;missing&quot;</span><span class="ex">:</span> <span class="st">&quot;_last&quot;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Source filtering:</li>
</ol>
<div class="sourceCode" id="cb66"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Include only specific fields</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;title&quot;</span>, <span class="st">&quot;author&quot;</span>, <span class="st">&quot;published_at&quot;</span>]</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude fields</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;excludes&quot;</span><span class="ex">:</span> [<span class="st">&quot;content&quot;</span>]</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern matching</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;includes&quot;</span><span class="ex">:</span> [<span class="st">&quot;title&quot;</span>, <span class="st">&quot;published_*&quot;</span>],</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;excludes&quot;</span><span class="ex">:</span> [<span class="st">&quot;content&quot;</span>]</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Pagination with from/size:</li>
</ol>
<div class="sourceCode" id="cb67"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Page 1</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;from&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;published_at&quot;</span>: <span class="st">&quot;desc&quot;</span> }]</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Page 2</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;from&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;published_at&quot;</span>: <span class="st">&quot;desc&quot;</span> }]</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Search After (for deep pagination):</li>
</ol>
<div class="sourceCode" id="cb68"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First page</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;published_at&quot;</span><span class="ex">:</span> <span class="st">&quot;desc&quot;</span> },</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;_id&quot;</span><span class="ex">:</span> <span class="st">&quot;asc&quot;</span> }</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the sort values from the last hit for next page</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} },</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;published_at&quot;</span><span class="ex">:</span> <span class="st">&quot;desc&quot;</span> },</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span> <span class="st">&quot;_id&quot;</span><span class="ex">:</span> <span class="st">&quot;asc&quot;</span> }</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">],</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;search_after&quot;</span><span class="ex">:</span> [<span class="st">&quot;2025-01-14&quot;</span>, <span class="st">&quot;3&quot;</span>]</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="6" type="1">
<li>Track total hits:</li>
</ol>
<div class="sourceCode" id="cb69"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;track_total_hits&quot;</span><span class="ex">:</span> true,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} }</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Or set a threshold</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;track_total_hits&quot;</span><span class="ex">:</span> 100,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> { <span class="st">&quot;match_all&quot;</span>: {} }</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Get page 2 of articles (2 per page),
sorted by views descending, showing only title and views - Why is
<code>search_after</code> better than <code>from/size</code> for deep
pagination? - Implement cursor-based pagination for the
parking-locations index</p>
<hr />
<h1 id="part-6-aggregations">Part 6: Aggregations</h1>
<h2 id="exercise-6.1-metric-aggregations-with-pipeline">Exercise 6.1:
Metric Aggregations with Pipeline</h2>
<p><strong>Objective</strong>: Calculate statistics and derived
metrics.</p>
<p><strong>Setup</strong>: Create a comprehensive transactions
index:</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /transactions</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;spot_type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;amount&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;float&quot;</span> },</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;duration_minutes&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;payment_method&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;user_type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;day_of_week&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T08:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:12.50</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:120</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;card&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T09:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;ev_charging&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:18.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:90</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;mobile&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;premium&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;north&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:8.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:60</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;card&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T11:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;handicap&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:6.50</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:45</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;cash&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T14:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;north&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:20.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:240</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;mobile&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;premium&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T15:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;south&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;ev_charging&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:25.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:180</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;card&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;premium&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T16:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:10.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:90</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;mobile&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;wednesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-14T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:15.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:150</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;card&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;tuesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-14T12:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;north&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:12.00</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:120</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;cash&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;regular&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;tuesday&quot;</span><span class="dt">}</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;transactions&quot;</span><span class="ex">}}</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-14T15:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;south&quot;</span><span class="op">,</span><span class="st">&quot;spot_type&quot;</span><span class="dt">:</span><span class="st">&quot;standard&quot;</span><span class="op">,</span><span class="st">&quot;amount&quot;</span><span class="dt">:8.50</span><span class="op">,</span><span class="st">&quot;duration_minutes&quot;</span><span class="dt">:60</span><span class="op">,</span><span class="st">&quot;payment_method&quot;</span><span class="dt">:</span><span class="st">&quot;mobile&quot;</span><span class="op">,</span><span class="st">&quot;user_type&quot;</span><span class="dt">:</span><span class="st">&quot;premium&quot;</span><span class="op">,</span><span class="st">&quot;day_of_week&quot;</span><span class="dt">:</span><span class="st">&quot;tuesday&quot;</span><span class="dt">}</span></span></code></pre></div>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Extended stats with percentiles:</li>
</ol>
<div class="sourceCode" id="cb71"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;amount_stats&quot;</span><span class="ex">:</span> { <span class="st">&quot;extended_stats&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;amount_percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;amount&quot;</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;percents&quot;</span><span class="ex">:</span> [25, 50, 75, 90, 99]</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;duration_percentile_ranks&quot;</span><span class="ex">:</span> {</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;percentile_ranks&quot;</span><span class="ex">:</span> {</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;duration_minutes&quot;</span>,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;values&quot;</span><span class="ex">:</span> [60, 120, 180]</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Weighted average:</li>
</ol>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;weighted_avg_rate&quot;</span><span class="ex">:</span> {</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;weighted_avg&quot;</span><span class="ex">:</span> {</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> {</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;script&quot;</span><span class="ex">:</span> <span class="st">&quot;doc[&#39;amount&#39;].value / doc[&#39;duration_minutes&#39;].value * 60&quot;</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;weight&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;duration_minutes&quot;</span> }</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Pipeline aggregations:</li>
</ol>
<div class="sourceCode" id="cb73"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;daily_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;calendar_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;day&quot;</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_transaction&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;total_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;sum_bucket&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> <span class="st">&quot;daily_revenue&gt;revenue&quot;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;avg_daily_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;avg_bucket&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> <span class="st">&quot;daily_revenue&gt;revenue&quot;</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;max_day_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;max_bucket&quot;</span><span class="ex">:</span> {</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> <span class="st">&quot;daily_revenue&gt;revenue&quot;</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Derivative (rate of change):</li>
</ol>
<div class="sourceCode" id="cb74"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;hourly&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;calendar_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;hour&quot;</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_doc_count&quot;</span><span class="ex">:</span> 0</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue_change&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;derivative&quot;</span><span class="ex">:</span> {</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> <span class="st">&quot;revenue&quot;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - What is the 90th percentile for
transaction amounts? - What percentage of transactions are under 2
hours? - Calculate the revenue per minute rate for each parking</p>
<hr />
<h2 id="exercise-6.2-bucket-aggregations-with-filters">Exercise 6.2:
Bucket Aggregations with Filters</h2>
<p><strong>Objective</strong>: Group data into meaningful buckets.</p>
<p><strong>Setup</strong>: Use the <code>transactions</code> index.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Terms with order and size:</li>
</ol>
<div class="sourceCode" id="cb75"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;top_parkings_by_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> {</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;parking_id&quot;</span>,</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;size&quot;</span><span class="ex">:</span> 10,</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;order&quot;</span><span class="ex">:</span> { <span class="st">&quot;total_revenue&quot;</span>: <span class="st">&quot;desc&quot;</span> }</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;total_revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;transaction_count&quot;</span><span class="ex">:</span> { <span class="st">&quot;value_count&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Histogram and date histogram:</li>
</ol>
<div class="sourceCode" id="cb76"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;amount_distribution&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;amount&quot;</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;interval&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_doc_count&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;extended_bounds&quot;</span><span class="ex">:</span> { <span class="st">&quot;min&quot;</span>: 0, <span class="st">&quot;max&quot;</span>: 30 }</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;hourly_distribution&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;calendar_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;hour&quot;</span>,</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;format&quot;</span><span class="ex">:</span> <span class="st">&quot;HH:mm&quot;</span>,</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;time_zone&quot;</span><span class="ex">:</span> <span class="st">&quot;Europe/Paris&quot;</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Filters aggregation:</li>
</ol>
<div class="sourceCode" id="cb77"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;transaction_categories&quot;</span><span class="ex">:</span> {</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filters&quot;</span><span class="ex">:</span> {</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;filters&quot;</span><span class="ex">:</span> {</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;small&quot;</span><span class="ex">:</span> { <span class="st">&quot;range&quot;</span>: { <span class="st">&quot;amount&quot;</span>: { <span class="st">&quot;lt&quot;</span>: 10 } } },</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;medium&quot;</span><span class="ex">:</span> { <span class="st">&quot;range&quot;</span>: { <span class="st">&quot;amount&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 10, <span class="st">&quot;lt&quot;</span>: 20 } } },</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;large&quot;</span><span class="ex">:</span> { <span class="st">&quot;range&quot;</span>: { <span class="st">&quot;amount&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 20 } } }</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_duration&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;duration_minutes&quot;</span> } },</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Composite aggregation (for pagination):</li>
</ol>
<div class="sourceCode" id="cb78"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;parking_payment_combos&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;composite&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sources&quot;</span><span class="ex">:</span> [</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;parking&quot;</span><span class="ex">:</span> { <span class="st">&quot;terms&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> } } },</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;payment&quot;</span><span class="ex">:</span> { <span class="st">&quot;terms&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;payment_method&quot;</span> } } }</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Next page using after_key from response</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;parking_payment_combos&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;composite&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sources&quot;</span><span class="ex">:</span> [</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;parking&quot;</span><span class="ex">:</span> { <span class="st">&quot;terms&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> } } },</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;payment&quot;</span><span class="ex">:</span> { <span class="st">&quot;terms&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;payment_method&quot;</span> } } }</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>        <span class="ex">],</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;after&quot;</span><span class="ex">:</span> { <span class="st">&quot;parking&quot;</span>: <span class="st">&quot;central&quot;</span>, <span class="st">&quot;payment&quot;</span>: <span class="st">&quot;mobile&quot;</span> }</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Significant terms (find unusual patterns):</li>
</ol>
<div class="sourceCode" id="cb79"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;user_type&quot;</span>: <span class="st">&quot;premium&quot;</span> }</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;significant_spot_types&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;significant_terms&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;spot_type&quot;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;significant_payment&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;significant_terms&quot;</span><span class="ex">:</span> {</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;payment_method&quot;</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Which payment method is most
significant for premium users? - Create an hourly revenue chart for
January 15th - Find the top 3 parking-payment combinations by
revenue</p>
<hr />
<h2 id="exercise-6.3-nested-aggregations-and-post-filters">Exercise 6.3:
Nested Aggregations and Post-Filters</h2>
<p><strong>Objective</strong>: Build complex multi-level
aggregations.</p>
<p><strong>Setup</strong>: Use the <code>transactions</code> index.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Multi-level aggregation:</li>
</ol>
<div class="sourceCode" id="cb80"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_parking&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> },</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_spot_type&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;spot_type&quot;</span> },</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;avg_duration&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;duration_minutes&quot;</span> } },</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;by_payment&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;payment_method&quot;</span> },</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;count&quot;</span><span class="ex">:</span> { <span class="st">&quot;value_count&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } }</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>              <span class="kw">}</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;total_revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue_share&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;bucket_script&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> {</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;spot_revenue&quot;</span><span class="ex">:</span> <span class="st">&quot;by_spot_type&gt;revenue&quot;</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span><span class="ex">,</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;script&quot;</span><span class="ex">:</span> <span class="st">&quot;params.spot_revenue&quot;</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Post-filter (filter results, not aggregations):</li>
</ol>
<div class="sourceCode" id="cb81"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match_all&quot;</span><span class="ex">:</span> {}</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;post_filter&quot;</span><span class="ex">:</span> {</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;payment_method&quot;</span>: <span class="st">&quot;card&quot;</span> }</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;all_payment_methods&quot;</span><span class="ex">:</span> {</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;payment_method&quot;</span> }</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Bucket selector (filter buckets):</li>
</ol>
<div class="sourceCode" id="cb82"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_parking&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> },</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;transaction_count&quot;</span><span class="ex">:</span> { <span class="st">&quot;value_count&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;high_revenue_filter&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;bucket_selector&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;buckets_path&quot;</span><span class="ex">:</span> {</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;rev&quot;</span><span class="ex">:</span> <span class="st">&quot;revenue&quot;</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>            <span class="ex">},</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;script&quot;</span><span class="ex">:</span> <span class="st">&quot;params.rev &gt; 30&quot;</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Bucket sort:</li>
</ol>
<div class="sourceCode" id="cb83"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /transactions/_search</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_payment&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;payment_method&quot;</span>,</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;size&quot;</span><span class="ex">:</span> 10</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;revenue&quot;</span><span class="ex">:</span> { <span class="st">&quot;sum&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_amount&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;amount&quot;</span> } },</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sort_by_revenue&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;bucket_sort&quot;</span><span class="ex">:</span> {</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;revenue&quot;</span>: { <span class="st">&quot;order&quot;</span>: <span class="st">&quot;desc&quot;</span> } }],</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;size&quot;</span><span class="ex">:</span> 3</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Calculate each parking’s percentage of
total revenue - Find parking lots with more than 3 transactions AND
revenue &gt; 30€ - Show all payment method counts, but only return
documents with “card” payment</p>
<hr />
<h1 id="part-7-ingest-pipelines">Part 7: Ingest Pipelines</h1>
<h2 id="exercise-7.1-multi-processor-pipeline">Exercise 7.1:
Multi-Processor Pipeline</h2>
<p><strong>Objective</strong>: Create a comprehensive data
transformation pipeline.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a complex pipeline:</li>
</ol>
<div class="sourceCode" id="cb84"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_ingest/pipeline/parking-logs-pipeline</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;description&quot;</span><span class="ex">:</span> <span class="st">&quot;Comprehensive parking log processing&quot;</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;processors&quot;</span><span class="ex">:</span> [</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;ingested_at&quot;</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> <span class="st">&quot;{{_ingest.timestamp}}&quot;</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;lowercase&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;level&quot;</span>,</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;trim&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;message&quot;</span>,</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;gsub&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;user_id&quot;</span>,</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pattern&quot;</span><span class="ex">:</span> <span class="st">&quot;^user[-_]?&quot;</span>,</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;replacement&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;split&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;tags&quot;</span>,</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;separator&quot;</span><span class="ex">:</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;severity_score&quot;</span>,</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.level == &#39;debug&#39;&quot;</span></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;severity_score&quot;</span>,</span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.level == &#39;info&#39;&quot;</span></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;severity_score&quot;</span>,</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> 3,</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.level == &#39;warn&#39; || ctx.level == &#39;warning&#39;&quot;</span></span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;severity_score&quot;</span>,</span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> 4,</span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.level == &#39;error&#39;&quot;</span></span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;remove&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> [<span class="st">&quot;temp&quot;</span>, <span class="st">&quot;debug_info&quot;</span>],</span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>  <span class="ex">],</span></span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;on_failure&quot;</span><span class="ex">:</span> [</span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;_index&quot;</span>,</span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> <span class="st">&quot;failed-logs&quot;</span></span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;error.message&quot;</span>,</span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> <span class="st">&quot;{{ _ingest.on_failure_message }}&quot;</span></span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;error.processor&quot;</span>,</span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> <span class="st">&quot;{{ _ingest.on_failure_processor_type }}&quot;</span></span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Test with various documents:</li>
</ol>
<div class="sourceCode" id="cb85"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_ingest/pipeline/parking-logs-pipeline/_simulate</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;docs&quot;</span><span class="ex">:</span> [</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;ERROR&quot;</span>,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;  Connection timeout  &quot;</span>,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user-123&quot;</span>,</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;tags&quot;</span><span class="ex">:</span> <span class="st">&quot;parking,api,timeout&quot;</span>,</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;temp&quot;</span><span class="ex">:</span> <span class="st">&quot;temporary_data&quot;</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;INFO&quot;</span>,</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;Normal operation&quot;</span>,</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user_456&quot;</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;DEBUG&quot;</span>,</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;Debug info&quot;</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Index documents using the pipeline:</li>
</ol>
<div class="sourceCode" id="cb86"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /processed-logs/_doc<span class="pp">?</span>pipeline=parking-logs-pipeline</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;WARN&quot;</span>,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;  High latency detected  &quot;</span>,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user-789&quot;</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;tags&quot;</span><span class="ex">:</span> <span class="st">&quot;performance,warning&quot;</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;temp&quot;</span><span class="ex">:</span> <span class="st">&quot;should_be_removed&quot;</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /processed-logs/_search</span></code></pre></div>
<p><strong>Challenge</strong>: - Add a processor that extracts the first
word from the message as a new field <code>action</code> - Add a
processor that sets <code>is_critical</code> to true if severity_score
&gt;= 4 - What happens if <code>level</code> is an unexpected value?</p>
<hr />
<h2 id="exercise-7.2-grok-and-dissect-processors">Exercise 7.2: Grok and
Dissect Processors</h2>
<p><strong>Objective</strong>: Parse complex unstructured logs.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a Grok pipeline for application logs:</li>
</ol>
<div class="sourceCode" id="cb87"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_ingest/pipeline/app-logs-parser</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;description&quot;</span><span class="ex">:</span> <span class="st">&quot;Parse structured application logs&quot;</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;processors&quot;</span><span class="ex">:</span> [</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;grok&quot;</span><span class="ex">:</span> {</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;message&quot;</span>,</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;patterns&quot;</span><span class="ex">:</span> [</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;</span><span class="dt">\\</span><span class="st">[%{TIMESTAMP_ISO8601:log_timestamp}</span><span class="dt">\\</span><span class="st">] </span><span class="dt">\\</span><span class="st">[%{LOGLEVEL:level}</span><span class="dt">\\</span><span class="st">] </span><span class="dt">\\</span><span class="st">[%{DATA:service}</span><span class="dt">\\</span><span class="st">] </span><span class="dt">\\</span><span class="st">[%{DATA:trace_id}</span><span class="dt">\\</span><span class="st">] %{GREEDYDATA:log_message}&quot;</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        <span class="ex">],</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pattern_definitions&quot;</span><span class="ex">:</span> {</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;LOGLEVEL&quot;</span><span class="ex">:</span> <span class="st">&quot;DEBUG|INFO|WARN|ERROR|FATAL&quot;</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date&quot;</span><span class="ex">:</span> {</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;log_timestamp&quot;</span>,</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;formats&quot;</span><span class="ex">:</span> [<span class="st">&quot;ISO8601&quot;</span>],</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;target_field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;remove&quot;</span><span class="ex">:</span> {</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> [<span class="st">&quot;log_timestamp&quot;</span>, <span class="st">&quot;message&quot;</span>]</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Test the Grok pipeline:</li>
</ol>
<div class="sourceCode" id="cb88"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_ingest/pipeline/app-logs-parser/_simulate</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;docs&quot;</span><span class="ex">:</span> [</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;[2025-01-15T10:30:45.123Z] [ERROR] [parking-api] [abc123-def456] User authentication failed for user_id=789&quot;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;[2025-01-15T10:30:46.456Z] [INFO] [payment-service] [xyz789-uvw012] Payment processed successfully amount=25.50&quot;</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Create a Dissect pipeline (faster, simpler):</li>
</ol>
<div class="sourceCode" id="cb89"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_ingest/pipeline/access-logs-parser</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;description&quot;</span><span class="ex">:</span> <span class="st">&quot;Parse access logs with dissect&quot;</span>,</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;processors&quot;</span><span class="ex">:</span> [</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;dissect&quot;</span><span class="ex">:</span> {</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;message&quot;</span>,</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pattern&quot;</span><span class="ex">:</span> <span class="st">&quot;%{client_ip} - %{user} [%{timestamp}] </span><span class="dt">\&quot;</span><span class="st">%{method} %{path} %{protocol}</span><span class="dt">\&quot;</span><span class="st"> %{status} %{bytes}&quot;</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;convert&quot;</span><span class="ex">:</span> {</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;status&quot;</span>,</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;integer&quot;</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;convert&quot;</span><span class="ex">:</span> {</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;bytes&quot;</span>,</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span><span class="ex">:</span> <span class="st">&quot;integer&quot;</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;geoip&quot;</span><span class="ex">:</span> {</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;client_ip&quot;</span>,</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;target_field&quot;</span><span class="ex">:</span> <span class="st">&quot;geo&quot;</span>,</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;user_agent&quot;</span><span class="ex">:</span> {</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;user_agent&quot;</span>,</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;target_field&quot;</span><span class="ex">:</span> <span class="st">&quot;ua&quot;</span>,</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ignore_missing&quot;</span><span class="ex">:</span> true</span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Test Dissect:</li>
</ol>
<div class="sourceCode" id="cb90"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_ingest/pipeline/access-logs-parser/_simulate</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;docs&quot;</span><span class="ex">:</span> [</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;192.168.1.100 - john [15/Jan/2025:10:30:00 +0000] </span><span class="dt">\&quot;</span><span class="st">GET /api/parking/status HTTP/1.1</span><span class="dt">\&quot;</span><span class="st"> 200 1234&quot;</span>,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_agent&quot;</span><span class="ex">:</span> <span class="st">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)&quot;</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Test Grok patterns online:</li>
</ol>
<div class="sourceCode" id="cb91"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_ingest/processor/grok</span></code></pre></div>
<p><strong>Challenge</strong>: - Create a pattern that extracts
key=value pairs from the log_message - Add a processor that categorizes
status codes (2xx=success, 4xx=client_error, 5xx=server_error) - Handle
logs that don’t match the expected format gracefully</p>
<hr />
<h2 id="exercise-7.3-enrichment-and-lookup">Exercise 7.3: Enrichment and
Lookup</h2>
<p><strong>Objective</strong>: Enrich documents with external data.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a lookup index:</li>
</ol>
<div class="sourceCode" id="cb92"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parking-info</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;text&quot;</span> },</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;address&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;text&quot;</span> },</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;city&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;capacity&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;integer&quot;</span> },</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;manager_email&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;parking-info&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Central Paris&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;15 Rue de Rivoli&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:500</span><span class="op">,</span><span class="st">&quot;manager_email&quot;</span><span class="dt">:</span><span class="st">&quot;central@parkki.com&quot;</span><span class="dt">}</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;parking-info&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;north&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;north&quot;</span><span class="op">,</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Gare du Nord&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;18 Rue de Dunkerque&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:300</span><span class="op">,</span><span class="st">&quot;manager_email&quot;</span><span class="dt">:</span><span class="st">&quot;north@parkki.com&quot;</span><span class="dt">}</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:</span><span class="dt">{</span><span class="st">&quot;_index&quot;</span><span class="dt">:</span><span class="st">&quot;parking-info&quot;</span><span class="op">,</span><span class="st">&quot;_id&quot;</span><span class="dt">:</span><span class="st">&quot;south&quot;</span><span class="dt">}</span><span class="ex">}</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;south&quot;</span><span class="op">,</span><span class="st">&quot;name&quot;</span><span class="dt">:</span><span class="st">&quot;Parking Montparnasse&quot;</span><span class="op">,</span><span class="st">&quot;address&quot;</span><span class="dt">:</span><span class="st">&quot;Place Raoul Dautry&quot;</span><span class="op">,</span><span class="st">&quot;city&quot;</span><span class="dt">:</span><span class="st">&quot;Paris&quot;</span><span class="op">,</span><span class="st">&quot;capacity&quot;</span><span class="dt">:400</span><span class="op">,</span><span class="st">&quot;manager_email&quot;</span><span class="dt">:</span><span class="st">&quot;south@parkki.com&quot;</span><span class="dt">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create an enrich policy:</li>
</ol>
<div class="sourceCode" id="cb93"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_enrich/policy/parking-lookup</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;indices&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-info&quot;</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match_field&quot;</span><span class="ex">:</span> <span class="st">&quot;parking_id&quot;</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;enrich_fields&quot;</span><span class="ex">:</span> [<span class="st">&quot;name&quot;</span>, <span class="st">&quot;city&quot;</span>, <span class="st">&quot;capacity&quot;</span>, <span class="st">&quot;manager_email&quot;</span>]</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the policy to create the enrich index</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_enrich/policy/parking-lookup/_execute</span></code></pre></div>
<ol start="3" type="1">
<li>Create a pipeline using the enrich policy:</li>
</ol>
<div class="sourceCode" id="cb94"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_ingest/pipeline/enrich-parking-events</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;description&quot;</span><span class="ex">:</span> <span class="st">&quot;Enrich parking events with parking info&quot;</span>,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;processors&quot;</span><span class="ex">:</span> [</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;enrich&quot;</span><span class="ex">:</span> {</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;policy_name&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-lookup&quot;</span>,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;parking_id&quot;</span>,</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;target_field&quot;</span><span class="ex">:</span> <span class="st">&quot;parking_info&quot;</span>,</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;max_matches&quot;</span><span class="ex">:</span> 1</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;set&quot;</span><span class="ex">:</span> {</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;enriched&quot;</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> true,</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.parking_info != null&quot;</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="st">          if (ctx.parking_info != null) {</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="st">            ctx.parking_name = ctx.parking_info.name;</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="st">            ctx.parking_city = ctx.parking_info.city;</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span>,</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;if&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx.parking_info != null&quot;</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Test the enrichment:</li>
</ol>
<div class="sourceCode" id="cb95"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_ingest/pipeline/enrich-parking-events/_simulate</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;docs&quot;</span><span class="ex">:</span> [</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;event_type&quot;</span><span class="ex">:</span> <span class="st">&quot;ENTRY&quot;</span>,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;central&quot;</span>,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user123&quot;</span>,</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;_source&quot;</span><span class="ex">:</span> {</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;event_type&quot;</span><span class="ex">:</span> <span class="st">&quot;EXIT&quot;</span>,</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;unknown&quot;</span>,</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user_id&quot;</span><span class="ex">:</span> <span class="st">&quot;user456&quot;</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Check enrich policy status:</li>
</ol>
<div class="sourceCode" id="cb96"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_enrich/policy/parking-lookup</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_enrich/_stats</span></code></pre></div>
<p><strong>Challenge</strong>: - Add a processor that sends an alert if
capacity &gt; 400 - Handle the case when parking_id is not found in the
lookup - Create a pipeline that combines Grok parsing AND enrichment</p>
<hr />
<h1 id="part-8-data-retention-and-ilm">Part 8: Data Retention and
ILM</h1>
<h2 id="exercise-8.1-complete-ilm-policy">Exercise 8.1: Complete ILM
Policy</h2>
<p><strong>Objective</strong>: Create a production-ready ILM policy.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a comprehensive ILM policy:</li>
</ol>
<div class="sourceCode" id="cb97"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_ilm/policy/parkki-logs-policy</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;policy&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;phases&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;hot&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_age&quot;</span><span class="ex">:</span> <span class="st">&quot;0ms&quot;</span>,</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;rollover&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;max_age&quot;</span><span class="ex">:</span> <span class="st">&quot;1d&quot;</span>,</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;max_primary_shard_size&quot;</span><span class="ex">:</span> <span class="st">&quot;25gb&quot;</span>,</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;max_docs&quot;</span><span class="ex">:</span> 10000000</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>          <span class="ex">},</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;set_priority&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 100</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;warm&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_age&quot;</span><span class="ex">:</span> <span class="st">&quot;2d&quot;</span>,</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;readonly&quot;</span><span class="ex">:</span> {},</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;shrink&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;forcemerge&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;max_num_segments&quot;</span><span class="ex">:</span> 1</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;set_priority&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 50</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;allocate&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;require&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;data&quot;</span><span class="ex">:</span> <span class="st">&quot;warm&quot;</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;cold&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_age&quot;</span><span class="ex">:</span> <span class="st">&quot;7d&quot;</span>,</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;set_priority&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 0</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;allocate&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;require&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;data&quot;</span><span class="ex">:</span> <span class="st">&quot;cold&quot;</span></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;delete&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_age&quot;</span><span class="ex">:</span> <span class="st">&quot;30d&quot;</span>,</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;wait_for_snapshot&quot;</span><span class="ex">:</span> {</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;policy&quot;</span><span class="ex">:</span> <span class="st">&quot;daily-snapshots&quot;</span></span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span><span class="ex">,</span></span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;delete&quot;</span><span class="ex">:</span> {}</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Check ILM status:</li>
</ol>
<div class="sourceCode" id="cb98"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_ilm/policy/parkki-logs-policy</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_ilm/status</span></code></pre></div>
<ol start="3" type="1">
<li>Create template with ILM:</li>
</ol>
<div class="sourceCode" id="cb99"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_index_template/logs-with-ilm</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index_patterns&quot;</span><span class="ex">:</span> [<span class="st">&quot;logs-ilm-*&quot;</span>],</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;data_stream&quot;</span><span class="ex">:</span> {},</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;index.lifecycle.name&quot;</span><span class="ex">:</span> <span class="st">&quot;parkki-logs-policy&quot;</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;message&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;text&quot;</span> },</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;level&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;service&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Create and populate the data stream:</li>
</ol>
<div class="sourceCode" id="cb100"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /logs-ilm-parkki/_doc</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span>,</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;Application started&quot;</span>,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;INFO&quot;</span>,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;service&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-api&quot;</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /logs-ilm-parkki/_doc</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:01:00Z&quot;</span>,</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;message&quot;</span><span class="ex">:</span> <span class="st">&quot;User login successful&quot;</span>,</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;level&quot;</span><span class="ex">:</span> <span class="st">&quot;INFO&quot;</span>,</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;service&quot;</span><span class="ex">:</span> <span class="st">&quot;auth-service&quot;</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Monitor ILM progress:</li>
</ol>
<div class="sourceCode" id="cb101"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /logs-ilm-parkki/_ilm/explain</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/.<span class="pp">*</span>logs-ilm<span class="pp">*?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,health,status,pri,rep,docs.count,store.size</span></code></pre></div>
<p><strong>Challenge</strong>: - Add a frozen phase before delete -
Modify the policy to keep 90 days in cold instead of deleting at 30 days
- How would you force an index to move to the next phase?</p>
<hr />
<h2 id="exercise-8.2-data-streams-with-rollover">Exercise 8.2: Data
Streams with Rollover</h2>
<p><strong>Objective</strong>: Manage time-series data efficiently.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a data stream template:</li>
</ol>
<div class="sourceCode" id="cb102"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_index_template/metrics-template</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index_patterns&quot;</span><span class="ex">:</span> [<span class="st">&quot;metrics-*&quot;</span>],</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;data_stream&quot;</span><span class="ex">:</span> {},</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;priority&quot;</span><span class="ex">:</span> 500,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;template&quot;</span><span class="ex">:</span> {</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;index.lifecycle.name&quot;</span><span class="ex">:</span> <span class="st">&quot;parkki-logs-policy&quot;</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;metric_name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;value&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;double&quot;</span> },</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;unit&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Index metrics into the data stream:</li>
</ol>
<div class="sourceCode" id="cb103"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /metrics-parkki/_doc</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span>,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;central&quot;</span>,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metric_name&quot;</span><span class="ex">:</span> <span class="st">&quot;occupancy_percent&quot;</span>,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;value&quot;</span><span class="ex">:</span> 78.5,</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;unit&quot;</span><span class="ex">:</span> <span class="st">&quot;percent&quot;</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /metrics-parkki/_doc</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:00:00Z&quot;</span>,</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;central&quot;</span>,</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metric_name&quot;</span><span class="ex">:</span> <span class="st">&quot;revenue_hourly&quot;</span>,</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;value&quot;</span><span class="ex">:</span> 245.50,</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;unit&quot;</span><span class="ex">:</span> <span class="st">&quot;euros&quot;</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /metrics-parkki/_doc</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-15T10:01:00Z&quot;</span>,</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;north&quot;</span>,</span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metric_name&quot;</span><span class="ex">:</span> <span class="st">&quot;occupancy_percent&quot;</span>,</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;value&quot;</span><span class="ex">:</span> 45.2,</span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;unit&quot;</span><span class="ex">:</span> <span class="st">&quot;percent&quot;</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>View data stream info:</li>
</ol>
<div class="sourceCode" id="cb104"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_data_stream/metrics-parkki</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/.ds-metrics-parkki-<span class="pp">*?</span>v</span></code></pre></div>
<ol start="4" type="1">
<li>Manual rollover:</li>
</ol>
<div class="sourceCode" id="cb105"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /metrics-parkki/_rollover</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;conditions&quot;</span><span class="ex">:</span> {</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;max_docs&quot;</span><span class="ex">:</span> 1</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Search across all backing indices:</li>
</ol>
<div class="sourceCode" id="cb106"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /metrics-parkki/_search</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;gte&quot;</span><span class="ex">:</span> <span class="st">&quot;now-1h&quot;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_parking&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> },</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_occupancy&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;avg&quot;</span><span class="ex">:</span> {</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - What’s the naming convention for
backing indices? - How do you delete old data from a data stream? -
Create a query that searches only the current write index</p>
<hr />
<h2 id="exercise-8.3-index-optimization-operations">Exercise 8.3: Index
Optimization Operations</h2>
<p><strong>Objective</strong>: Practice shrink, force merge, and clone
operations.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create and populate a test index:</li>
</ol>
<div class="sourceCode" id="cb107"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /test-optimization</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_shards&quot;</span><span class="ex">:</span> 2,</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;number_of_replicas&quot;</span><span class="ex">:</span> 0</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;test-optimization&quot;</span><span class="ex">}}</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;test 1&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:1}</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;test-optimization&quot;</span><span class="ex">}}</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;test 2&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:2}</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;test-optimization&quot;</span><span class="ex">}}</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;test 3&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:3}</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;test-optimization&quot;</span><span class="ex">}}</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;test 4&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:4}</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;test-optimization&quot;</span><span class="ex">}}</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;message&quot;</span><span class="dt">:</span><span class="st">&quot;test 5&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:5}</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Force refresh</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /test-optimization/_refresh</span></code></pre></div>
<ol start="2" type="1">
<li>Check segment info:</li>
</ol>
<div class="sourceCode" id="cb108"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/segments/test-optimization<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,shard,segment,docs.count,size</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /test-optimization/_stats/segments</span></code></pre></div>
<ol start="3" type="1">
<li>Force merge:</li>
</ol>
<div class="sourceCode" id="cb109"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /test-optimization/_forcemerge<span class="pp">?</span>max_num_segments=1</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check segments again</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/segments/test-optimization<span class="pp">?</span>v</span></code></pre></div>
<ol start="4" type="1">
<li>Clone an index:</li>
</ol>
<div class="sourceCode" id="cb110"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make source read-only</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /test-optimization/_settings</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index.blocks.write&quot;</span><span class="ex">:</span> true</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /test-optimization/_clone/test-optimization-clone</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/test-optimization<span class="pp">*?</span>v</span></code></pre></div>
<ol start="5" type="1">
<li>Reindex with transformation:</li>
</ol>
<div class="sourceCode" id="cb111"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_reindex</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;source&quot;</span><span class="ex">:</span> {</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index&quot;</span><span class="ex">:</span> <span class="st">&quot;test-optimization&quot;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;dest&quot;</span><span class="ex">:</span> {</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index&quot;</span><span class="ex">:</span> <span class="st">&quot;test-optimization-v2&quot;</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;ctx._source.value_doubled = ctx._source.value * 2&quot;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /test-optimization-v2/_search</span></code></pre></div>
<ol start="6" type="1">
<li>Clean up write block:</li>
</ol>
<div class="sourceCode" id="cb112"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /test-optimization/_settings</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;settings&quot;</span><span class="ex">:</span> {</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index.blocks.write&quot;</span><span class="ex">:</span> false</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - What’s the difference between clone and
reindex? - When would you use force merge? When should you avoid it? -
Create a reindex that only copies documents where value &gt; 2</p>
<hr />
<h1 id="part-9-operating-and-troubleshooting">Part 9: Operating and
Troubleshooting</h1>
<h2 id="exercise-9.1-comprehensive-cluster-diagnostics">Exercise 9.1:
Comprehensive Cluster Diagnostics</h2>
<p><strong>Objective</strong>: Master cluster health monitoring.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Full cluster health check:</li>
</ol>
<div class="sourceCode" id="cb113"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic health</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/health</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Detailed health with shard info</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/health<span class="pp">?</span>level=shards</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait for status</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/health<span class="pp">?</span>wait_for_status=green<span class="kw">&amp;</span><span class="va">timeout</span><span class="op">=</span>30s</span></code></pre></div>
<ol start="2" type="1">
<li>Node diagnostics:</li>
</ol>
<div class="sourceCode" id="cb114"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All nodes with key metrics</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/nodes<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>name,ip,heap.percent,ram.percent,cpu,load_1m,load_5m,disk.used_percent,node.role,master</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Node stats</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.name,nodes.<span class="pp">*</span>.indices.indexing,nodes.<span class="pp">*</span>.indices.search,nodes.<span class="pp">*</span>.jvm.mem</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Hot threads</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/hot_threads</span></code></pre></div>
<ol start="3" type="1">
<li>Index diagnostics:</li>
</ol>
<div class="sourceCode" id="cb115"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All indices sorted by size</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>store.size:desc<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,health,status,pri,rep,docs.count,docs.deleted,store.size,pri.store.size</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Index stats</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_stats<span class="pp">?</span>filter_path=_all.primaries</span></code></pre></div>
<ol start="4" type="1">
<li>Shard analysis:</li>
</ol>
<div class="sourceCode" id="cb116"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All shards with details</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/shards<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,shard,prirep,state,docs,store,ip,node,unassigned.reason<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>state</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Unassigned shards only</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/shards<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,shard,prirep,state,unassigned.reason<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>state:desc</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocation explanation</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/allocation/explain</span></code></pre></div>
<ol start="5" type="1">
<li>Task and pending operations:</li>
</ol>
<div class="sourceCode" id="cb117"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Current tasks</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_tasks</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pending cluster tasks</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/pending_tasks</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cancellable tasks</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_tasks<span class="pp">?</span>actions=<span class="pp">*</span>search<span class="pp">*</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Identify any nodes with high CPU or
memory usage - Check if there are any unassigned shards and explain why
- Monitor the indexing rate across all indices</p>
<hr />
<h2 id="exercise-9.2-jvm-and-memory-deep-dive">Exercise 9.2: JVM and
Memory Deep Dive</h2>
<p><strong>Objective</strong>: Diagnose and understand JVM behavior.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Heap analysis:</li>
</ol>
<div class="sourceCode" id="cb118"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Current heap usage</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/nodes<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>name,heap.percent,heap.current,heap.max,ram.percent,ram.current,ram.max</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Detailed JVM stats</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/jvm<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.name,nodes.<span class="pp">*</span>.jvm.mem,nodes.<span class="pp">*</span>.jvm.gc.collectors</span></code></pre></div>
<ol start="2" type="1">
<li>GC analysis:</li>
</ol>
<div class="sourceCode" id="cb119"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GC statistics</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/jvm<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.jvm.gc</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate GC time percentage (look at collection_time_in_millis)</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.jvm.gc.collectors,nodes.<span class="pp">*</span>.jvm.uptime_in_millis</span></code></pre></div>
<ol start="3" type="1">
<li>Circuit breakers:</li>
</ol>
<div class="sourceCode" id="cb120"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Circuit breaker status</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/breaker</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Current limits</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span>defaults.indices.breaker</span></code></pre></div>
<ol start="4" type="1">
<li>Cache analysis:</li>
</ol>
<div class="sourceCode" id="cb121"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fielddata cache</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/fielddata<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>node,field,size</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># All caches</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/indices<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.indices.fielddata,nodes.<span class="pp">*</span>.indices.query_cache,nodes.<span class="pp">*</span>.indices.request_cache</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear caches (use carefully!)</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co"># POST /_cache/clear</span></span></code></pre></div>
<ol start="5" type="1">
<li>Memory pools:</li>
</ol>
<div class="sourceCode" id="cb122"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detailed memory breakdown</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes/stats/jvm<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.jvm.mem.pools</span></code></pre></div>
<p><strong>Challenge</strong>: - What percentage of heap is used for
fielddata? - Which circuit breaker is closest to its limit? - Calculate
the cache hit ratio for the query cache</p>
<hr />
<h2 id="exercise-9.3-query-performance-analysis">Exercise 9.3: Query
Performance Analysis</h2>
<p><strong>Objective</strong>: Identify and fix slow queries.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Configure slow logs:</li>
</ol>
<div class="sourceCode" id="cb123"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /articles/_settings</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.query.warn&quot;</span><span class="ex">:</span> <span class="st">&quot;5s&quot;</span>,</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.query.info&quot;</span><span class="ex">:</span> <span class="st">&quot;2s&quot;</span>,</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.query.debug&quot;</span><span class="ex">:</span> <span class="st">&quot;500ms&quot;</span>,</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.query.trace&quot;</span><span class="ex">:</span> <span class="st">&quot;200ms&quot;</span>,</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.fetch.warn&quot;</span><span class="ex">:</span> <span class="st">&quot;1s&quot;</span>,</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.search.slowlog.threshold.fetch.info&quot;</span><span class="ex">:</span> <span class="st">&quot;500ms&quot;</span>,</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.indexing.slowlog.threshold.index.warn&quot;</span><span class="ex">:</span> <span class="st">&quot;10s&quot;</span>,</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index.indexing.slowlog.threshold.index.info&quot;</span><span class="ex">:</span> <span class="st">&quot;5s&quot;</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Profile a complex query:</li>
</ol>
<div class="sourceCode" id="cb124"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;profile&quot;</span><span class="ex">:</span> true,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;parking management technology&quot;</span> } }</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;should&quot;</span><span class="ex">:</span> [</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;category&quot;</span>: <span class="st">&quot;technology&quot;</span> } },</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;views&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 1000 } } }</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">],</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;published_at&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;2025-01-01&quot;</span> } } }</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_category&quot;</span><span class="ex">:</span> {</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;category&quot;</span> }</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Analyze the profile output:</li>
</ol>
<div class="sourceCode" id="cb125"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The profile response shows:</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - Time spent in each query component</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - Breakdown of rewrite, score, build_scorer, etc.</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - Which parts are slowest</span></span></code></pre></div>
<ol start="4" type="1">
<li>Explain query scoring:</li>
</ol>
<div class="sourceCode" id="cb126"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_explain/1</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;match&quot;</span><span class="ex">:</span> {</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;content&quot;</span><span class="ex">:</span> <span class="st">&quot;parking management&quot;</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Search templates for optimization:</li>
</ol>
<div class="sourceCode" id="cb127"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a search template</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_scripts/parking-search</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;lang&quot;</span><span class="ex">:</span> <span class="st">&quot;mustache&quot;</span>,</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;source&quot;</span><span class="ex">:</span> {</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">{</span> <span class="st">&quot;match&quot;</span><span class="ex">:</span> { <span class="st">&quot;content&quot;</span>: <span class="st">&quot;{{query_text}}&quot;</span> } }</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>          <span class="ex">],</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> [</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;published_at&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;{{from_date}}&quot;</span> } } }</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>          <span class="ex">]</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the template</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /articles/_search/template</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;id&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-search&quot;</span>,</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;params&quot;</span><span class="ex">:</span> {</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;query_text&quot;</span><span class="ex">:</span> <span class="st">&quot;parking&quot;</span>,</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;from_date&quot;</span><span class="ex">:</span> <span class="st">&quot;2025-01-01&quot;</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Which part of the profiled query takes
the longest? - How would you optimize a query that’s slow due to
wildcards? - Create a search template for the most common search
pattern</p>
<hr />
<h1 id="part-10-cluster-audit">Part 10: Cluster Audit</h1>
<h2 id="exercise-10.1-production-readiness-audit">Exercise 10.1:
Production Readiness Audit</h2>
<p><strong>Objective</strong>: Perform a comprehensive cluster
audit.</p>
<p><strong>Instructions</strong>:</p>
<p>Create a complete audit by running these queries and documenting
findings:</p>
<ol type="1">
<li><strong>Cluster Configuration Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb128"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cluster settings</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">flat_settings</span><span class="op">=</span>true</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check critical settings</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span>defaults.cluster.routing.allocation,defaults.indices.recovery</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Node roles</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_nodes<span class="pp">?</span>filter_path=nodes.<span class="pp">*</span>.roles,nodes.<span class="pp">*</span>.name</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Capacity Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb129"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Disk usage</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/allocation<span class="pp">?</span>v</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Shard count per node</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/nodes<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>name,node.role,shards,disk.used_percent</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Index sizes</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>store.size:desc<span class="kw">&amp;</span><span class="va">format</span><span class="op">=</span>json</span></code></pre></div>
<ol start="3" type="1">
<li><strong>Performance Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb130"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Thread pool rejections</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/thread_pool<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>node_name,name,active,queue,rejected,completed<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>rejected:desc</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Search and indexing stats</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_stats/search,indexing<span class="pp">?</span>filter_path=_all.primaries</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Segment memory</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/segments<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,shard,segment,size.memory<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>size.memory:desc</span></code></pre></div>
<ol start="4" type="1">
<li><strong>Mapping Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb131"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All mappings (check for text fields that should be keyword)</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_all/_mapping</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Field data usage (expensive text aggregations)</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/fielddata<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">format</span><span class="op">=</span>json<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>size:desc</span></code></pre></div>
<ol start="5" type="1">
<li><strong>Create Audit Report</strong>:</li>
</ol>
<div class="sourceCode" id="cb132"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary query</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/stats<span class="pp">?</span>filter_path=status,indices.count,indices.shards,indices.docs,nodes.count,nodes.os.mem</span></code></pre></div>
<p><strong>Challenge</strong>: - Document any findings that indicate
potential issues - Calculate the documents per shard ratio (should be
200k-500k ideally) - Identify any indices that might need more/fewer
shards</p>
<hr />
<h2 id="exercise-10.2-security-and-best-practices-audit">Exercise 10.2:
Security and Best Practices Audit</h2>
<p><strong>Objective</strong>: Verify security configuration and best
practices.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li><strong>Security Status</strong>:</li>
</ol>
<div class="sourceCode" id="cb133"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if security is enabled</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_xpack/security</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List users (if security is enabled)</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/user</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="co"># List roles</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/role</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Template Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb134"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List all templates</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_index_template</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for conflicting patterns</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_index_template/<span class="pp">*?</span>filter_path=index_templates.<span class="pp">*</span>.index_patterns</span></code></pre></div>
<ol start="3" type="1">
<li><strong>ILM Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb135"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All ILM policies</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_ilm/policy</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Indices with ILM issues</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /<span class="pp">*</span>/_ilm/explain<span class="pp">?</span>only_errors=true</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ILM status</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_ilm/status</span></code></pre></div>
<ol start="4" type="1">
<li><strong>Snapshot Audit</strong>:</li>
</ol>
<div class="sourceCode" id="cb136"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List repositories</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_snapshot</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check snapshot status (if configured)</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># GET /_snapshot/my_repository/_status</span></span></code></pre></div>
<ol start="5" type="1">
<li><strong>Best Practices Checklist</strong>:</li>
</ol>
<div class="sourceCode" id="cb137"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check refresh interval (should be 30s for logs)</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_all/_settings<span class="pp">?</span>filter_path=<span class="pp">*</span>.settings.index.refresh_interval</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check replica count</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices<span class="pp">?</span>v<span class="kw">&amp;</span><span class="va">h</span><span class="op">=</span>index,rep</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for very large documents</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_stats/store<span class="pp">?</span>filter_path=indices.<span class="pp">*</span>.primaries.store</span></code></pre></div>
<p><strong>Challenge</strong>: - Are all indices using appropriate
refresh intervals? - Do all log indices have ILM policies attached? -
Are there any templates without explicit mappings?</p>
<hr />
<h1 id="part-11-monitoring-with-elastic-stack">Part 11: Monitoring with
Elastic Stack</h1>
<h2 id="exercise-11.1-metricbeat-setup-and-configuration">Exercise 11.1:
Metricbeat Setup and Configuration</h2>
<p><strong>Objective</strong>: Install and configure Metricbeat to
monitor Elasticsearch.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Start Metricbeat with Docker:</li>
</ol>
<div class="sourceCode" id="cb138"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> metricbeat <span class="dt">\</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--net</span> elastic <span class="dt">\</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--user</span><span class="op">=</span>root <span class="dt">\</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> <span class="st">&quot;ELASTICSEARCH_HOSTS=http://elasticsearch:9200&quot;</span> <span class="dt">\</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> <span class="st">&quot;KIBANA_HOST=http://kibana:5601&quot;</span> <span class="dt">\</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  docker.elastic.co/beats/metricbeat:9.0.0 <span class="dt">\</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  metricbeat <span class="at">-e</span> <span class="at">-E</span> setup.kibana.host=kibana:5601</span></code></pre></div>
<ol start="2" type="1">
<li>Verify Metricbeat is sending data:</li>
</ol>
<div class="sourceCode" id="cb139"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /metricbeat-<span class="pp">*</span>/_search</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;@timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }]</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/metricbeat-<span class="pp">*?</span>v</span></code></pre></div>
<ol start="3" type="1">
<li>Check Elasticsearch module metrics:</li>
</ol>
<div class="sourceCode" id="cb140"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /metricbeat-<span class="pp">*</span>/_search</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metricset.name&quot;</span>: <span class="st">&quot;node_stats&quot;</span> } }</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;elasticsearch.node.stats.*&quot;</span>, <span class="st">&quot;@timestamp&quot;</span>]</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Query system metrics:</li>
</ol>
<div class="sourceCode" id="cb141"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /metricbeat-<span class="pp">*</span>/_search</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metricset.name&quot;</span>: <span class="st">&quot;cpu&quot;</span> } }</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;@timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;system.cpu.*&quot;</span>, <span class="st">&quot;@timestamp&quot;</span>, <span class="st">&quot;host.name&quot;</span>]</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Create a monitoring dashboard query:</li>
</ol>
<div class="sourceCode" id="cb142"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /metricbeat-<span class="pp">*</span>/_search</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> }</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;over_time&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fixed_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;5m&quot;</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span><span class="ex">,</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_cpu&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;avg&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;system.cpu.total.pct&quot;</span> }</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_memory&quot;</span><span class="ex">:</span> {</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;avg&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;system.memory.used.pct&quot;</span> }</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Find the peak CPU usage in the last
hour - Calculate the average heap usage percentage for Elasticsearch
nodes - Create an aggregation showing disk I/O over time</p>
<hr />
<h2 id="exercise-11.2-stack-monitoring-with-self-monitoring">Exercise
11.2: Stack Monitoring with Self-Monitoring</h2>
<p><strong>Objective</strong>: Enable and use Elasticsearch
self-monitoring.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Check monitoring settings:</li>
</ol>
<div class="sourceCode" id="cb143"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span><span class="pp">*</span>.xpack.monitoring</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_xpack/usage<span class="pp">?</span>filter_path=monitoring</span></code></pre></div>
<ol start="2" type="1">
<li>View monitoring indices:</li>
</ol>
<div class="sourceCode" id="cb144"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/.monitoring-<span class="pp">*?</span>v<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>index</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.monitoring-es-<span class="pp">*</span>/_search</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }]</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Query node statistics from monitoring:</li>
</ol>
<div class="sourceCode" id="cb145"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.monitoring-es-<span class="pp">*</span>/_search</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;node_stats&quot;</span> } },</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-15m&quot;</span> } } }</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;node_stats.jvm.*&quot;</span>, <span class="st">&quot;node_stats.os.*&quot;</span>, <span class="st">&quot;timestamp&quot;</span>]</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Query index statistics:</li>
</ol>
<div class="sourceCode" id="cb146"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.monitoring-es-<span class="pp">*</span>/_search</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;index_stats&quot;</span> } }</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;index_stats.index&quot;</span>, <span class="st">&quot;index_stats.primaries.*&quot;</span>]</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Create a health overview:</li>
</ol>
<div class="sourceCode" id="cb147"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.monitoring-es-<span class="pp">*</span>/_search</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;cluster_stats&quot;</span> } },</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;health_over_time&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;timestamp&quot;</span>,</span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fixed_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;5m&quot;</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;status&quot;</span><span class="ex">:</span> {</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;cluster_stats.status&quot;</span> }</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - How often has the cluster status
changed in the last 24 hours? - Find the index with the highest document
count from monitoring data - Calculate the total indexing rate across
all nodes</p>
<hr />
<h2 id="exercise-11.3-custom-monitoring-queries">Exercise 11.3: Custom
Monitoring Queries</h2>
<p><strong>Objective</strong>: Build custom monitoring and alerting
queries.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a monitoring index for custom metrics:</li>
</ol>
<div class="sourceCode" id="cb148"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /parkki-metrics</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;metric_type&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;value&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;double&quot;</span> },</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;unit&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;tags&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Index sample monitoring data:</li>
</ol>
<div class="sourceCode" id="cb149"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;occupancy&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:78.5</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;production&quot;</span><span class="op">,</span><span class="st">&quot;paris&quot;</span><span class="dt">]}</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:05:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;occupancy&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:82.3</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;production&quot;</span><span class="op">,</span><span class="st">&quot;paris&quot;</span><span class="dt">]}</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:10:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;occupancy&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:95.1</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;production&quot;</span><span class="op">,</span><span class="st">&quot;paris&quot;</span><span class="dt">]}</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;response_time&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:45</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;ms&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:05:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;response_time&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:120</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;ms&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:10:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;response_time&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:2500</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;ms&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;error_rate&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:0.5</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:05:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;error_rate&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:1.2</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;parkki-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:10:00Z&quot;</span><span class="op">,</span><span class="st">&quot;metric_type&quot;</span><span class="dt">:</span><span class="st">&quot;error_rate&quot;</span><span class="op">,</span><span class="st">&quot;parking_id&quot;</span><span class="dt">:</span><span class="st">&quot;central&quot;</span><span class="op">,</span><span class="st">&quot;value&quot;</span><span class="dt">:15.8</span><span class="op">,</span><span class="st">&quot;unit&quot;</span><span class="dt">:</span><span class="st">&quot;percent&quot;</span><span class="op">,</span><span class="st">&quot;tags&quot;</span><span class="dt">:[</span><span class="st">&quot;api&quot;</span><span class="op">,</span><span class="st">&quot;production&quot;</span><span class="dt">]}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Detect anomalies (high values):</li>
</ol>
<div class="sourceCode" id="cb150"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parkki-metrics/_search</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metric_type&quot;</span>: <span class="st">&quot;response_time&quot;</span> } },</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;value&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 1000 } } }</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Calculate percentiles for SLA monitoring:</li>
</ol>
<div class="sourceCode" id="cb151"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parkki-metrics/_search</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metric_type&quot;</span>: <span class="st">&quot;response_time&quot;</span> }</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;response_percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;percents&quot;</span><span class="ex">:</span> [50, 90, 95, 99]</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;over_threshold&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;filter&quot;</span><span class="ex">:</span> {</span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;value&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 500 } }</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Create a health score aggregation:</li>
</ol>
<div class="sourceCode" id="cb152"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /parkki-metrics/_search</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_parking&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> },</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_metric&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;metric_type&quot;</span> },</span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;latest&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;top_hits&quot;</span><span class="ex">:</span> {</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;size&quot;</span><span class="ex">:</span> 1,</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;@timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;value&quot;</span>, <span class="st">&quot;@timestamp&quot;</span>]</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>              <span class="kw">}</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span><span class="ex">,</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;avg_value&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span> } },</span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;max_value&quot;</span><span class="ex">:</span> { <span class="st">&quot;max&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span> } }</span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Create a query that detects when
error_rate exceeds 5% - Build an aggregation that shows the trend
(increasing/decreasing) for each metric - Calculate the percentage of
time response_time was above SLA (500ms)</p>
<hr />
<h1 id="part-12-alerting-with-watcher">Part 12: Alerting with
Watcher</h1>
<h2 id="exercise-12.1-basic-watcher-alert">Exercise 12.1: Basic Watcher
Alert</h2>
<p><strong>Objective</strong>: Create alerts for cluster and application
issues.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a simple error rate alert:</li>
</ol>
<div class="sourceCode" id="cb153"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/high_error_rate</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;5m&quot;</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;search&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [<span class="st">&quot;logs-parkki-*&quot;</span>],</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;body&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;level&quot;</span>: <span class="st">&quot;ERROR&quot;</span> } },</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-5m&quot;</span> } } }</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>              <span class="ex">]</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">}</span></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>          <span class="ex">},</span></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;error_count&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;value_count&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;level.keyword&quot;</span> }</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">}</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;compare&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ctx.payload.aggregations.error_count.value&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;gte&quot;</span><span class="ex">:</span> 10</span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_alert&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;High error rate detected: {{ctx.payload.aggregations.error_count.value}} errors in last 5 minutes&quot;</span></span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create a cluster health alert:</li>
</ol>
<div class="sourceCode" id="cb154"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/cluster_health_alert</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;1m&quot;</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;http&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;host&quot;</span><span class="ex">:</span> <span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;port&quot;</span><span class="ex">:</span> 9200,</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;path&quot;</span><span class="ex">:</span> <span class="st">&quot;/_cluster/health&quot;</span>,</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;scheme&quot;</span><span class="ex">:</span> <span class="st">&quot;http&quot;</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;compare&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ctx.payload.status&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;not_eq&quot;</span><span class="ex">:</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_alert&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;Cluster health is {{ctx.payload.status}}! Unassigned shards: {{ctx.payload.unassigned_shards}}&quot;</span></span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Check watcher status:</li>
</ol>
<div class="sourceCode" id="cb155"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_watcher/stats</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_watcher/watch/high_error_rate</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_watcher/watch/cluster_health_alert</span></code></pre></div>
<ol start="4" type="1">
<li>Execute a watch manually:</li>
</ol>
<div class="sourceCode" id="cb156"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_watcher/watch/high_error_rate/_execute</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;ignore_condition&quot;</span><span class="ex">:</span> true</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>View watch history:</li>
</ol>
<div class="sourceCode" id="cb157"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.watcher-history-<span class="pp">*</span>/_search</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;watch_id&quot;</span>: <span class="st">&quot;high_error_rate&quot;</span> }</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;trigger_event.triggered_time&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Modify the error rate alert to also
check for specific error codes - Create an alert that triggers when disk
usage exceeds 80% - Add a throttle to prevent alert fatigue (max 1 alert
per hour)</p>
<hr />
<h2 id="exercise-12.2-advanced-alerting-with-conditions">Exercise 12.2:
Advanced Alerting with Conditions</h2>
<p><strong>Objective</strong>: Create complex multi-condition
alerts.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create an alert with multiple conditions:</li>
</ol>
<div class="sourceCode" id="cb158"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/parking_capacity_alert</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;2m&quot;</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;search&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [<span class="st">&quot;parkki-metrics&quot;</span>],</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;body&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metric_type&quot;</span>: <span class="st">&quot;occupancy&quot;</span> } },</span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-10m&quot;</span> } } }</span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>              <span class="ex">]</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">}</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>          <span class="ex">},</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;by_parking&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;parking_id&quot;</span> },</span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;avg_occupancy&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span> } },</span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;max_occupancy&quot;</span><span class="ex">:</span> { <span class="st">&quot;max&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span> } }</span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>              <span class="kw">}</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a><span class="st">        def buckets = ctx.payload.aggregations.by_parking.buckets;</span></span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a><span class="st">        for (bucket in buckets) {</span></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a><span class="st">          if (bucket.max_occupancy.value &gt;= 95) {</span></span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a><span class="st">            return true;</span></span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a><span class="st">        return false;</span></span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;&quot;&quot;</span></span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;transform&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a><span class="st">        def alerts = [];</span></span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a><span class="st">        def buckets = ctx.payload.aggregations.by_parking.buckets;</span></span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a><span class="st">        for (bucket in buckets) {</span></span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a><span class="st">          if (bucket.max_occupancy.value &gt;= 95) {</span></span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a><span class="st">            alerts.add([</span></span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a><span class="st">              &#39;parking&#39;: bucket.key,</span></span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a><span class="st">              &#39;occupancy&#39;: bucket.max_occupancy.value</span></span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a><span class="st">            ]);</span></span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a><span class="st">        return [&#39;alerts&#39;: alerts, &#39;count&#39;: alerts.size()];</span></span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;&quot;&quot;</span></span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_alert&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb158-68"><a href="#cb158-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;Parking capacity critical! {{ctx.payload.count}} parking(s) at &gt;95%: {{ctx.payload.alerts}}&quot;</span></span>
<span id="cb158-69"><a href="#cb158-69" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb158-70"><a href="#cb158-70" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb158-71"><a href="#cb158-71" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb158-72"><a href="#cb158-72" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create a response time degradation alert:</li>
</ol>
<div class="sourceCode" id="cb159"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/response_time_degradation</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;5m&quot;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;chain&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;inputs&quot;</span><span class="ex">:</span> [</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;current&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;search&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [<span class="st">&quot;parkki-metrics&quot;</span>],</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;body&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metric_type&quot;</span>: <span class="st">&quot;response_time&quot;</span> } },</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-5m&quot;</span> } } }</span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>                      <span class="ex">]</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">}</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>                  <span class="ex">},</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;p95&quot;</span><span class="ex">:</span> { <span class="st">&quot;percentiles&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span>, <span class="st">&quot;percents&quot;</span>: [95] } }</span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">}</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">}</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>              <span class="er">}</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;baseline&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;search&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [<span class="st">&quot;parkki-metrics&quot;</span>],</span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;body&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;metric_type&quot;</span>: <span class="st">&quot;response_time&quot;</span> } },</span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span>, <span class="st">&quot;lte&quot;</span>: <span class="st">&quot;now-5m&quot;</span> } } }</span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>                      <span class="ex">]</span></span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">}</span></span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>                  <span class="ex">},</span></span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;p95&quot;</span><span class="ex">:</span> { <span class="st">&quot;percentiles&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;value&quot;</span>, <span class="st">&quot;percents&quot;</span>: [95] } }</span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">}</span></span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a>                <span class="kw">}</span></span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>              <span class="er">}</span></span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a><span class="st">        def current_p95 = ctx.payload.current.aggregations.p95.values[&#39;95.0&#39;];</span></span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a><span class="st">        def baseline_p95 = ctx.payload.baseline.aggregations.p95.values[&#39;95.0&#39;];</span></span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a><span class="st">        return current_p95 &gt; baseline_p95 * 2;</span></span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;&quot;&quot;</span></span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_alert&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;Response time degradation detected! Current P95 is more than 2x baseline.&quot;</span></span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Activate/deactivate watches:</li>
</ol>
<div class="sourceCode" id="cb160"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deactivate a watch</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/high_error_rate/_deactivate</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Activate a watch</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/high_error_rate/_activate</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check status</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_watcher/watch/high_error_rate</span></code></pre></div>
<ol start="4" type="1">
<li>Delete a watch:</li>
</ol>
<div class="sourceCode" id="cb161"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/response_time_degradation</span></code></pre></div>
<p><strong>Challenge</strong>: - Create an alert that detects sudden
spikes (3x normal) in any metric - Build a watch that correlates high
error rates with high response times - Add email action to send alerts
(configure with your SMTP settings)</p>
<hr />
<h2 id="exercise-12.3-alerting-best-practices">Exercise 12.3: Alerting
Best Practices</h2>
<p><strong>Objective</strong>: Implement production-ready alerting
patterns.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create an alert with throttling:</li>
</ol>
<div class="sourceCode" id="cb162"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/throttled_error_alert</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;1m&quot;</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;search&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [<span class="st">&quot;logs-parkki-*&quot;</span>],</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;body&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;level&quot;</span>: <span class="st">&quot;ERROR&quot;</span> } },</span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1m&quot;</span> } } }</span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>              <span class="ex">]</span></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">}</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;compare&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ctx.payload.hits.total.value&quot;</span><span class="ex">:</span> { <span class="st">&quot;gte&quot;</span>: 5 }</span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;throttle_period&quot;</span><span class="ex">:</span> <span class="st">&quot;30m&quot;</span>,</span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_alert&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;Error threshold exceeded: {{ctx.payload.hits.total.value}} errors&quot;</span></span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create a watch with acknowledgement:</li>
</ol>
<div class="sourceCode" id="cb163"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/critical_system_alert</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;trigger&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schedule&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;interval&quot;</span><span class="ex">:</span> <span class="st">&quot;1m&quot;</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;input&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;http&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;request&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;host&quot;</span><span class="ex">:</span> <span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;port&quot;</span><span class="ex">:</span> 9200,</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;path&quot;</span><span class="ex">:</span> <span class="st">&quot;/_cat/nodes?format=json&amp;h=name,heap.percent&quot;</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;condition&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;script&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;source&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a><span class="st">        for (node in ctx.payload) {</span></span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a><span class="st">          if (node[&#39;heap.percent&#39;] != null &amp;&amp; Integer.parseInt(node[&#39;heap.percent&#39;]) &gt; 90) {</span></span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a><span class="st">            return true;</span></span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a><span class="st">        return false;</span></span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;&quot;&quot;</span></span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;actions&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;log_critical&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;logging&quot;</span><span class="ex">:</span> {</span>
<span id="cb163-32"><a href="#cb163-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text&quot;</span><span class="ex">:</span> <span class="st">&quot;CRITICAL: Node heap usage above 90%!&quot;</span></span>
<span id="cb163-33"><a href="#cb163-33" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb163-34"><a href="#cb163-34" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb163-35"><a href="#cb163-35" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb163-36"><a href="#cb163-36" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Acknowledge an alert:</li>
</ol>
<div class="sourceCode" id="cb164"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_watcher/watch/critical_system_alert/_ack</span></code></pre></div>
<ol start="4" type="1">
<li>View acknowledgement status:</li>
</ol>
<div class="sourceCode" id="cb165"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_watcher/watch/critical_system_alert<span class="pp">?</span>filter_path=status.actions</span></code></pre></div>
<p><strong>Challenge</strong>: - Implement an escalation pattern (warn
-&gt; critical -&gt; page) - Create a maintenance window by deactivating
watches on schedule - Build a watch that auto-resolves when the
condition clears</p>
<hr />
<h1 id="part-13-security">Part 13: Security</h1>
<h2 id="exercise-13.1-user-and-role-management">Exercise 13.1: User and
Role Management</h2>
<p><strong>Objective</strong>: Configure users, roles, and
permissions.</p>
<p><strong>Note</strong>: Security must be enabled for these exercises.
If using the training Docker setup without security, these are
simulation exercises.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Check security status:</li>
</ol>
<div class="sourceCode" id="cb166"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/_authenticate</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_xpack/security</span></code></pre></div>
<ol start="2" type="1">
<li>Create a role for parking operators:</li>
</ol>
<div class="sourceCode" id="cb167"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_security/role/parking_operator</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cluster&quot;</span><span class="ex">:</span> [<span class="st">&quot;monitor&quot;</span>],</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;parking-*&quot;</span>, <span class="st">&quot;logs-parkki-*&quot;</span>],</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;read&quot;</span>, <span class="st">&quot;view_index_metadata&quot;</span>],</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;field_security&quot;</span><span class="ex">:</span> {</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;grant&quot;</span><span class="ex">:</span> [<span class="st">&quot;*&quot;</span>],</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;except&quot;</span><span class="ex">:</span> [<span class="st">&quot;user_id&quot;</span>, <span class="st">&quot;payment_details&quot;</span>]</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;reservations&quot;</span>],</span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;read&quot;</span>, <span class="st">&quot;write&quot;</span>, <span class="st">&quot;delete&quot;</span>],</span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;parking_id&quot;</span>: <span class="st">&quot;{{_user.metadata.parking_id}}&quot;</span> }</span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Create a role for data analysts:</li>
</ol>
<div class="sourceCode" id="cb168"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_security/role/data_analyst</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cluster&quot;</span><span class="ex">:</span> [<span class="st">&quot;monitor&quot;</span>],</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;transactions&quot;</span>, <span class="st">&quot;parkki-metrics&quot;</span>],</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;read&quot;</span>],</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;field_security&quot;</span><span class="ex">:</span> {</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;grant&quot;</span><span class="ex">:</span> [<span class="st">&quot;@timestamp&quot;</span>, <span class="st">&quot;parking_id&quot;</span>, <span class="st">&quot;amount&quot;</span>, <span class="st">&quot;duration_minutes&quot;</span>, <span class="st">&quot;spot_type&quot;</span>]</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">],</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;applications&quot;</span><span class="ex">:</span> [</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;application&quot;</span><span class="ex">:</span> <span class="st">&quot;kibana-.kibana&quot;</span>,</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;feature_dashboard.read&quot;</span>, <span class="st">&quot;feature_discover.read&quot;</span>],</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;resources&quot;</span><span class="ex">:</span> [<span class="st">&quot;*&quot;</span>]</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Create users:</li>
</ol>
<div class="sourceCode" id="cb169"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_security/user/operator_paris</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;password&quot;</span><span class="ex">:</span> <span class="st">&quot;operator123!&quot;</span>,</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;roles&quot;</span><span class="ex">:</span> [<span class="st">&quot;parking_operator&quot;</span>],</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;full_name&quot;</span><span class="ex">:</span> <span class="st">&quot;Paris Parking Operator&quot;</span>,</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;email&quot;</span><span class="ex">:</span> <span class="st">&quot;operator@parkki-paris.com&quot;</span>,</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metadata&quot;</span><span class="ex">:</span> {</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;parking_id&quot;</span><span class="ex">:</span> <span class="st">&quot;central&quot;</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /_security/user/analyst_john</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;password&quot;</span><span class="ex">:</span> <span class="st">&quot;analyst123!&quot;</span>,</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;roles&quot;</span><span class="ex">:</span> [<span class="st">&quot;data_analyst&quot;</span>],</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;full_name&quot;</span><span class="ex">:</span> <span class="st">&quot;John Analyst&quot;</span>,</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;email&quot;</span><span class="ex">:</span> <span class="st">&quot;john@parkki.com&quot;</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Test user permissions:</li>
</ol>
<div class="sourceCode" id="cb170"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run as a specific user</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_security/user/_has_privileges</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cluster&quot;</span><span class="ex">:</span> [<span class="st">&quot;manage&quot;</span>, <span class="st">&quot;monitor&quot;</span>],</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;index&quot;</span><span class="ex">:</span> [</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;transactions&quot;</span>],</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;read&quot;</span>, <span class="st">&quot;write&quot;</span>]</span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Create a role that can only read
documents from the last 7 days - Implement a role that allows write
access only during business hours (using a script) - Create an API key
with limited permissions for a microservice</p>
<hr />
<h2 id="exercise-13.2-api-keys-and-service-accounts">Exercise 13.2: API
Keys and Service Accounts</h2>
<p><strong>Objective</strong>: Manage programmatic access to
Elasticsearch.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create an API key:</li>
</ol>
<div class="sourceCode" id="cb171"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_security/api_key</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-api-key&quot;</span>,</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;expiration&quot;</span><span class="ex">:</span> <span class="st">&quot;30d&quot;</span>,</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;role_descriptors&quot;</span><span class="ex">:</span> {</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;parking_read&quot;</span><span class="ex">:</span> {</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;cluster&quot;</span><span class="ex">:</span> [<span class="st">&quot;monitor&quot;</span>],</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;parking-*&quot;</span>],</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;read&quot;</span>]</span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;metadata&quot;</span><span class="ex">:</span> {</span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;application&quot;</span><span class="ex">:</span> <span class="st">&quot;parking-api&quot;</span>,</span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;environment&quot;</span><span class="ex">:</span> <span class="st">&quot;production&quot;</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Create a more restricted API key:</li>
</ol>
<div class="sourceCode" id="cb172"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_security/api_key</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;metrics-writer&quot;</span>,</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;role_descriptors&quot;</span><span class="ex">:</span> {</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;metrics_write&quot;</span><span class="ex">:</span> {</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;indices&quot;</span><span class="ex">:</span> [</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;names&quot;</span><span class="ex">:</span> [<span class="st">&quot;parkki-metrics&quot;</span>],</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;privileges&quot;</span><span class="ex">:</span> [<span class="st">&quot;create_index&quot;</span>, <span class="st">&quot;write&quot;</span>]</span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>List API keys:</li>
</ol>
<div class="sourceCode" id="cb173"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/api_key<span class="pp">?</span>owner=true</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/api_key<span class="pp">?</span>name=parking-<span class="pp">*</span></span></code></pre></div>
<ol start="4" type="1">
<li>Get API key info:</li>
</ol>
<div class="sourceCode" id="cb174"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_security/api_key<span class="pp">?</span>id=<span class="op">&lt;</span>api_key_id<span class="op">&gt;</span></span></code></pre></div>
<ol start="5" type="1">
<li>Invalidate an API key:</li>
</ol>
<div class="sourceCode" id="cb175"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_security/api_key</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span><span class="ex">:</span> <span class="st">&quot;metrics-writer&quot;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="6" type="1">
<li>Create a service account token:</li>
</ol>
<div class="sourceCode" id="cb176"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_security/service/elastic/fleet-server/credential/token/my-token</span></code></pre></div>
<p><strong>Challenge</strong>: - Create an API key that expires in 1
hour for temporary access - Implement API key rotation (create new,
migrate, invalidate old) - Create different API keys for read and write
operations</p>
<hr />
<h2 id="exercise-13.3-audit-logging">Exercise 13.3: Audit Logging</h2>
<p><strong>Objective</strong>: Configure and analyze security audit
logs.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Check audit settings:</li>
</ol>
<div class="sourceCode" id="cb177"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cluster/settings<span class="pp">?</span>include_defaults=true<span class="kw">&amp;</span><span class="va">filter_path</span><span class="op">=</span><span class="pp">*</span>.xpack.security.audit</span></code></pre></div>
<ol start="2" type="1">
<li>Query audit logs (if enabled):</li>
</ol>
<div class="sourceCode" id="cb178"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.security-audit-<span class="pp">*</span>/_search</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;@timestamp&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 20</span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Find failed authentication attempts:</li>
</ol>
<div class="sourceCode" id="cb179"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.security-audit-<span class="pp">*</span>/_search</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;event.action&quot;</span>: <span class="st">&quot;authentication_failed&quot;</span> } }</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_user&quot;</span><span class="ex">:</span> {</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;user.name&quot;</span> }</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_ip&quot;</span><span class="ex">:</span> {</span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;source.ip&quot;</span> }</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Detect suspicious activity patterns:</li>
</ol>
<div class="sourceCode" id="cb180"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.security-audit-<span class="pp">*</span>/_search</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-24h&quot;</span> } }</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_action&quot;</span><span class="ex">:</span> {</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;event.action&quot;</span> },</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_user&quot;</span><span class="ex">:</span> {</span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;user.name&quot;</span>, <span class="st">&quot;size&quot;</span>: 5 }</span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Create a security dashboard query:</li>
</ol>
<div class="sourceCode" id="cb181"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /.security-audit-<span class="pp">*</span>/_search</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-7d&quot;</span> } }</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;auth_over_time&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;calendar_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;day&quot;</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;success&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> { <span class="st">&quot;term&quot;</span>: { <span class="st">&quot;event.action&quot;</span>: <span class="st">&quot;authentication_success&quot;</span> } }</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;failed&quot;</span><span class="ex">:</span> {</span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> { <span class="st">&quot;term&quot;</span>: { <span class="st">&quot;event.action&quot;</span>: <span class="st">&quot;authentication_failed&quot;</span> } }</span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Find all privilege escalation attempts
- Detect brute force attacks (multiple failed logins from same IP) -
Create a query that identifies off-hours access</p>
<hr />
<h1 id="part-14-apm-application-performance-monitoring">Part 14: APM
(Application Performance Monitoring)</h1>
<h2 id="exercise-14.1-apm-data-exploration">Exercise 14.1: APM Data
Exploration</h2>
<p><strong>Objective</strong>: Query and analyze APM data.</p>
<p><strong>Note</strong>: APM must be configured with the APM Server and
agents. These exercises work with APM indices if available.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Check APM indices:</li>
</ol>
<div class="sourceCode" id="cb182"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/apm-<span class="pp">*?</span>v<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>index</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /_cat/indices/traces-<span class="pp">*?</span>v<span class="kw">&amp;</span><span class="va">s</span><span class="op">=</span>index</span></code></pre></div>
<ol start="2" type="1">
<li>Query transaction data:</li>
</ol>
<div class="sourceCode" id="cb183"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } },</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 5,</span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;transaction.name&quot;</span>, <span class="st">&quot;transaction.duration.us&quot;</span>, <span class="st">&quot;service.name&quot;</span>, <span class="st">&quot;@timestamp&quot;</span>]</span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Calculate service latency:</li>
</ol>
<div class="sourceCode" id="cb184"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } },</span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_service&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;service.name&quot;</span> },</span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_duration&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;avg&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.duration.us&quot;</span> }</span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;transaction.duration.us&quot;</span>,</span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;percents&quot;</span><span class="ex">:</span> [50, 95, 99]</span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Find slow transactions:</li>
</ol>
<div class="sourceCode" id="cb185"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } },</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;transaction.duration.us&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 5000000 } } }</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;transaction.duration.us&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 10,</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;transaction.name&quot;</span>, <span class="st">&quot;transaction.duration.us&quot;</span>, <span class="st">&quot;service.name&quot;</span>, <span class="st">&quot;trace.id&quot;</span>]</span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Analyze error rates:</li>
</ol>
<div class="sourceCode" id="cb186"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } }</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_service&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;service.name&quot;</span> },</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;total&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> { <span class="st">&quot;term&quot;</span>: { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } }</span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;errors&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filter&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } },</span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;exists&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.result&quot;</span> } },</span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;transaction.result&quot;</span>: <span class="st">&quot;HTTP 5xx&quot;</span> } }</span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>              <span class="ex">]</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">}</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Calculate the error rate percentage for
each service - Find transactions that have associated spans taking more
than 1 second - Build a service dependency map by analyzing span
data</p>
<hr />
<h2 id="exercise-14.2-distributed-tracing-analysis">Exercise 14.2:
Distributed Tracing Analysis</h2>
<p><strong>Objective</strong>: Analyze traces across services.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Get a complete trace:</li>
</ol>
<div class="sourceCode" id="cb187"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;trace.id&quot;</span>: <span class="st">&quot;&lt;trace_id&gt;&quot;</span> }</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;timestamp.us&quot;</span>: <span class="st">&quot;asc&quot;</span> }],</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 100,</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;transaction.name&quot;</span>, <span class="st">&quot;span.name&quot;</span>, <span class="st">&quot;parent.id&quot;</span>, <span class="st">&quot;timestamp.us&quot;</span>, <span class="st">&quot;transaction.duration.us&quot;</span>, <span class="st">&quot;span.duration.us&quot;</span>, <span class="st">&quot;service.name&quot;</span>]</span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Find traces with errors:</li>
</ol>
<div class="sourceCode" id="cb188"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;error&quot;</span> } },</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;error_traces&quot;</span><span class="ex">:</span> {</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;trace.id&quot;</span>, <span class="st">&quot;size&quot;</span>: 10 }</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Analyze span breakdown:</li>
</ol>
<div class="sourceCode" id="cb189"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;span&quot;</span> } },</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_type&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;span.type&quot;</span> },</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_subtype&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;span.subtype&quot;</span> },</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;avg_duration&quot;</span><span class="ex">:</span> { <span class="st">&quot;avg&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;span.duration.us&quot;</span> } },</span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;count&quot;</span><span class="ex">:</span> { <span class="st">&quot;value_count&quot;</span>: { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;span.id&quot;</span> } }</span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>Find database query bottlenecks:</li>
</ol>
<div class="sourceCode" id="cb190"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;span.type&quot;</span>: <span class="st">&quot;db&quot;</span> } },</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;span.duration.us&quot;</span>: { <span class="st">&quot;gte&quot;</span>: 100000 } } }</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sort&quot;</span><span class="ex">:</span> [{ <span class="st">&quot;span.duration.us&quot;</span>: <span class="st">&quot;desc&quot;</span> }],</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 10,</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_source&quot;</span><span class="ex">:</span> [<span class="st">&quot;span.name&quot;</span>, <span class="st">&quot;span.duration.us&quot;</span>, <span class="st">&quot;span.db.statement&quot;</span>, <span class="st">&quot;service.name&quot;</span>]</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Calculate service throughput:</li>
</ol>
<div class="sourceCode" id="cb191"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /traces-apm<span class="pp">*</span>/_search</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;query&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bool&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;must&quot;</span><span class="ex">:</span> [</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;term&quot;</span><span class="ex">:</span> { <span class="st">&quot;processor.event&quot;</span>: <span class="st">&quot;transaction&quot;</span> } },</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">{</span> <span class="st">&quot;range&quot;</span><span class="ex">:</span> { <span class="st">&quot;@timestamp&quot;</span>: { <span class="st">&quot;gte&quot;</span>: <span class="st">&quot;now-1h&quot;</span> } } }</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">]</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">},</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;throughput&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;date_histogram&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;@timestamp&quot;</span>,</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fixed_interval&quot;</span><span class="ex">:</span> <span class="st">&quot;1m&quot;</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_service&quot;</span><span class="ex">:</span> {</span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;service.name&quot;</span> }</span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Build a query to find the slowest
database queries per service - Identify external HTTP calls that are
causing latency - Create a service level objective (SLO) query for 99th
percentile latency</p>
<hr />
<h2 id="exercise-14.3-custom-apm-metrics-and-analysis">Exercise 14.3:
Custom APM Metrics and Analysis</h2>
<p><strong>Objective</strong>: Create custom APM dashboards and
analyses.</p>
<p><strong>Instructions</strong>:</p>
<ol type="1">
<li>Create a simulated APM metrics index:</li>
</ol>
<div class="sourceCode" id="cb192"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PUT</span> /apm-custom-metrics</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mappings&quot;</span><span class="ex">:</span> {</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;properties&quot;</span><span class="ex">:</span> {</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@timestamp&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;date&quot;</span> },</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;service.name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;transaction.name&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;transaction.duration.us&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;long&quot;</span> },</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;transaction.result&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> },</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;labels&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;object&quot;</span> },</span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;user.id&quot;</span><span class="ex">:</span> { <span class="st">&quot;type&quot;</span>: <span class="st">&quot;keyword&quot;</span> }</span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="2" type="1">
<li>Index sample APM data:</li>
</ol>
<div class="sourceCode" id="cb193"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="ex">POST</span> /_bulk</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:00Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;GET /api/parking/status&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:45000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 2xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user123&quot;</span><span class="dt">}</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:01Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;POST /api/reservations&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:120000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 2xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user456&quot;</span><span class="dt">}</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:02Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;payment-service&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;POST /api/payment/process&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:2500000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 5xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user456&quot;</span><span class="dt">}</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:03Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;GET /api/parking/status&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:35000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 2xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user789&quot;</span><span class="dt">}</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:04Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;notification-service&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;POST /api/notify&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:350000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 2xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user123&quot;</span><span class="dt">}</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;index&quot;</span><span class="ex">:{</span><span class="st">&quot;_index&quot;</span><span class="ex">:</span><span class="st">&quot;apm-custom-metrics&quot;</span><span class="ex">}}</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;@timestamp&quot;</span><span class="dt">:</span><span class="st">&quot;2025-01-15T10:00:05Z&quot;</span><span class="op">,</span><span class="st">&quot;service.name&quot;</span><span class="dt">:</span><span class="st">&quot;parking-api&quot;</span><span class="op">,</span><span class="st">&quot;transaction.name&quot;</span><span class="dt">:</span><span class="st">&quot;GET /api/parking/status&quot;</span><span class="op">,</span><span class="st">&quot;transaction.duration.us&quot;</span><span class="dt">:5500000</span><span class="op">,</span><span class="st">&quot;transaction.result&quot;</span><span class="dt">:</span><span class="st">&quot;HTTP 5xx&quot;</span><span class="op">,</span><span class="st">&quot;labels&quot;</span><span class="dt">:{</span><span class="st">&quot;environment&quot;</span><span class="dt">:</span><span class="st">&quot;production&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;user.id&quot;</span><span class="dt">:</span><span class="st">&quot;user999&quot;</span><span class="dt">}</span></span></code></pre></div>
<ol start="3" type="1">
<li>Service health dashboard:</li>
</ol>
<div class="sourceCode" id="cb194"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /apm-custom-metrics/_search</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_service&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;service.name&quot;</span> },</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;avg_latency_ms&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;avg&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;script&quot;</span><span class="ex">:</span> { <span class="st">&quot;source&quot;</span>: <span class="st">&quot;doc[&#39;transaction.duration.us&#39;].value / 1000&quot;</span> }</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;p99_latency&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;percentiles&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;transaction.duration.us&quot;</span>,</span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;percents&quot;</span><span class="ex">:</span> [99]</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;error_rate&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;filters&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;filters&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;success&quot;</span><span class="ex">:</span> { <span class="st">&quot;prefix&quot;</span>: { <span class="st">&quot;transaction.result&quot;</span>: <span class="st">&quot;HTTP 2&quot;</span> } },</span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;error&quot;</span><span class="ex">:</span> { <span class="st">&quot;prefix&quot;</span>: { <span class="st">&quot;transaction.result&quot;</span>: <span class="st">&quot;HTTP 5&quot;</span> } }</span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a>          <span class="er">}</span></span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="ex">,</span></span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;throughput&quot;</span><span class="ex">:</span> {</span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;value_count&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.name&quot;</span> }</span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span></span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb194-32"><a href="#cb194-32" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb194-33"><a href="#cb194-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<ol start="4" type="1">
<li>User experience analysis:</li>
</ol>
<div class="sourceCode" id="cb195"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /apm-custom-metrics/_search</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;user_experience&quot;</span><span class="ex">:</span> {</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;range&quot;</span><span class="ex">:</span> {</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;field&quot;</span><span class="ex">:</span> <span class="st">&quot;transaction.duration.us&quot;</span>,</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ranges&quot;</span><span class="ex">:</span> [</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;fast&quot;</span>, <span class="st">&quot;to&quot;</span>: 100000 },</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;normal&quot;</span>, <span class="st">&quot;from&quot;</span>: 100000, <span class="st">&quot;to&quot;</span>: 500000 },</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;slow&quot;</span>, <span class="st">&quot;from&quot;</span>: 500000, <span class="st">&quot;to&quot;</span>: 2000000 },</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span> <span class="st">&quot;key&quot;</span><span class="ex">:</span> <span class="st">&quot;frustrated&quot;</span>, <span class="st">&quot;from&quot;</span>: 2000000 }</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">},</span></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;apdex&quot;</span><span class="ex">:</span> {</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;scripted_metric&quot;</span><span class="ex">:</span> {</span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;init_script&quot;</span><span class="ex">:</span> <span class="st">&quot;state.satisfied = 0; state.tolerating = 0; state.frustrated = 0;&quot;</span>,</span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;map_script&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a><span class="st">          def duration = doc[&#39;transaction.duration.us&#39;].value;</span></span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a><span class="st">          if (duration &lt; 100000) { state.satisfied++ }</span></span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a><span class="st">          else if (duration &lt; 400000) { state.tolerating++ }</span></span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a><span class="st">          else { state.frustrated++ }</span></span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span>,</span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;combine_script&quot;</span><span class="ex">:</span> <span class="st">&quot;return state&quot;</span>,</span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;reduce_script&quot;</span><span class="ex">:</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a><span class="st">          def satisfied = 0; def tolerating = 0; def frustrated = 0;</span></span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a><span class="st">          for (s in states) {</span></span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a><span class="st">            satisfied += s.satisfied;</span></span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a><span class="st">            tolerating += s.tolerating;</span></span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a><span class="st">            frustrated += s.frustrated;</span></span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb195-33"><a href="#cb195-33" aria-hidden="true" tabindex="-1"></a><span class="st">          def total = satisfied + tolerating + frustrated;</span></span>
<span id="cb195-34"><a href="#cb195-34" aria-hidden="true" tabindex="-1"></a><span class="st">          return (satisfied + (tolerating / 2.0)) / total;</span></span>
<span id="cb195-35"><a href="#cb195-35" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb195-36"><a href="#cb195-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb195-37"><a href="#cb195-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb195-38"><a href="#cb195-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb195-39"><a href="#cb195-39" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<ol start="5" type="1">
<li>Transaction breakdown:</li>
</ol>
<div class="sourceCode" id="cb196"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> /apm-custom-metrics/_search</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;size&quot;</span><span class="ex">:</span> 0,</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;by_transaction&quot;</span><span class="ex">:</span> {</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.name&quot;</span> },</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;aggs&quot;</span><span class="ex">:</span> {</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;stats&quot;</span><span class="ex">:</span> {</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;extended_stats&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.duration.us&quot;</span> }</span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>        <span class="ex">},</span></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;by_result&quot;</span><span class="ex">:</span> {</span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;terms&quot;</span><span class="ex">:</span> { <span class="st">&quot;field&quot;</span>: <span class="st">&quot;transaction.result&quot;</span> }</span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">}</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: - Calculate the Apdex score for each
service - Find users experiencing the worst performance - Create a query
to detect transaction duration anomalies (&gt;3 standard deviations)</p>
<hr />
<h1 id="cleanup">Cleanup</h1>
<h2 id="remove-all-test-indices-and-resources">Remove All Test Indices
and Resources</h2>
<div class="sourceCode" id="cb197"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete test indices</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /products</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-parkki</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /reservations</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-events</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-lots</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-with-spots</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-flat</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-nested</span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-parkki-<span class="pp">*</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-nginx-<span class="pp">*</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /articles</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-locations</span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /transactions</span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-test</span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /test-shrink</span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /test-optimization<span class="pp">*</span></span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-ilm-<span class="pp">*</span></span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /logs-ds-<span class="pp">*</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /metrics-<span class="pp">*</span></span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /processed-logs</span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parking-info</span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /failed-logs</span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /parkki-metrics</span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /apm-custom-metrics</span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete templates</span></span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_index_template/logs-template</span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_index_template/logs-parkki-template</span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_index_template/logs-with-ilm</span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_index_template/logs-ds-template</span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_index_template/metrics-template</span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_component_template/base-settings</span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_component_template/logs-mappings</span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_component_template/parkki-mappings</span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_component_template/logs-common</span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete pipelines</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/parking-logs-pipeline</span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/app-logs-parser</span>
<span id="cb197-42"><a href="#cb197-42" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/access-logs-parser</span>
<span id="cb197-43"><a href="#cb197-43" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/enrich-parking-events</span>
<span id="cb197-44"><a href="#cb197-44" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/logs-pipeline</span>
<span id="cb197-45"><a href="#cb197-45" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/apache-logs</span>
<span id="cb197-46"><a href="#cb197-46" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ingest/pipeline/parking-enrichment</span>
<span id="cb197-47"><a href="#cb197-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-48"><a href="#cb197-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete enrich policies</span></span>
<span id="cb197-49"><a href="#cb197-49" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_enrich/policy/parking-lookup</span>
<span id="cb197-50"><a href="#cb197-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-51"><a href="#cb197-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete ILM policies</span></span>
<span id="cb197-52"><a href="#cb197-52" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ilm/policy/parkki-logs-policy</span>
<span id="cb197-53"><a href="#cb197-53" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_ilm/policy/logs-lifecycle</span>
<span id="cb197-54"><a href="#cb197-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-55"><a href="#cb197-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete search templates</span></span>
<span id="cb197-56"><a href="#cb197-56" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_scripts/parking-search</span>
<span id="cb197-57"><a href="#cb197-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-58"><a href="#cb197-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete watchers</span></span>
<span id="cb197-59"><a href="#cb197-59" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/high_error_rate</span>
<span id="cb197-60"><a href="#cb197-60" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/cluster_health_alert</span>
<span id="cb197-61"><a href="#cb197-61" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/parking_capacity_alert</span>
<span id="cb197-62"><a href="#cb197-62" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/response_time_degradation</span>
<span id="cb197-63"><a href="#cb197-63" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/throttled_error_alert</span>
<span id="cb197-64"><a href="#cb197-64" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_watcher/watch/critical_system_alert</span>
<span id="cb197-65"><a href="#cb197-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-66"><a href="#cb197-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete security resources (if security is enabled)</span></span>
<span id="cb197-67"><a href="#cb197-67" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_security/role/parking_operator</span>
<span id="cb197-68"><a href="#cb197-68" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_security/role/data_analyst</span>
<span id="cb197-69"><a href="#cb197-69" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_security/user/operator_paris</span>
<span id="cb197-70"><a href="#cb197-70" aria-hidden="true" tabindex="-1"></a><span class="ex">DELETE</span> /_security/user/analyst_john</span></code></pre></div>
<hr />
<h1 id="summary">Summary</h1>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 16%" />
<col style="width: 28%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="header">
<th>Part</th>
<th>Topic</th>
<th>Key Skills</th>
<th>Challenge Level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>Installation</td>
<td>Docker setup, cluster health, node analysis</td>
<td>Basic</td>
</tr>
<tr class="even">
<td>3</td>
<td>Indexing</td>
<td>CRUD, Bulk API, optimistic locking</td>
<td>Intermediate</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Mapping</td>
<td>Analyzers, multi-fields, nested, templates</td>
<td>Intermediate</td>
</tr>
<tr class="even">
<td>5</td>
<td>Search</td>
<td>Full-text, bool, geo, scoring</td>
<td>Advanced</td>
</tr>
<tr class="odd">
<td>6</td>
<td>Aggregations</td>
<td>Metrics, buckets, pipelines, nested</td>
<td>Advanced</td>
</tr>
<tr class="even">
<td>7</td>
<td>Ingest</td>
<td>Multi-processor, grok, enrichment</td>
<td>Intermediate</td>
</tr>
<tr class="odd">
<td>8</td>
<td>ILM</td>
<td>Policies, data streams, optimization</td>
<td>Intermediate</td>
</tr>
<tr class="even">
<td>9</td>
<td>Troubleshooting</td>
<td>Diagnostics, JVM, profiling</td>
<td>Advanced</td>
</tr>
<tr class="odd">
<td>10</td>
<td>Audit</td>
<td>Full cluster analysis</td>
<td>Advanced</td>
</tr>
<tr class="even">
<td>11</td>
<td>Monitoring</td>
<td>Metricbeat, self-monitoring, custom metrics</td>
<td>Advanced</td>
</tr>
<tr class="odd">
<td>12</td>
<td>Alerting</td>
<td>Watcher, conditions, throttling</td>
<td>Advanced</td>
</tr>
<tr class="even">
<td>13</td>
<td>Security</td>
<td>Roles, users, API keys, audit logs</td>
<td>Advanced</td>
</tr>
<tr class="odd">
<td>14</td>
<td>APM</td>
<td>Transactions, traces, latency analysis</td>
<td>Advanced</td>
</tr>
</tbody>
</table>
<p><strong>Next Steps</strong>: - Apply these techniques to your
production cluster - Set up monitoring dashboards in Kibana - Configure
alerting for critical metrics - Review and optimize your mappings
regularly - Implement proper security with role-based access control -
Configure APM agents for your application services</p>
</body>
</html>
