# Practical Work

In this document, we will present the practical part of the training.

## Lab 1: Indexing

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch Getting Started Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html)
- [Determining Shard Count](https://www.elastic.co/blog/how-many-shards-should-i-have-in-my-elasticsearch-cluster)

During this lab, we will practice the following points:

- Indexing documents
- Retrieving, modifying, and deleting documents
- Executing bulk queries

### Indexing

To create a dataset, we will use the website [json-generator.com](https://www.json-generator.com/).

Please use the following generator:

```json
[
  "{{repeat(3, 3)}}",
  {
    "isActive": "{{bool()}}",
    "balance": "{{floating(1000, 4000, 2, \"$0,0.00\")}}",
    "picture": "http://placehold.it/32x32",
    "age": "{{integer(20, 40)}}",
    "eyeColor": "{{random(\"blue\", \"brown\", \"green\")}}",
    "name": "{{firstName()}} {{surname()}}",
    "gender": "{{gender()}}",
    "company": "{{company().toUpperCase()}}",
    "email": "{{email()}}",
    "phone": "+1 {{phone()}}",
    "address": "{{integer(100, 999)}} {{street()}}, {{city()}}, {{state()}}, {{integer(100, 10000)}}",
    "about": "{{lorem(1, \"paragraphs\")}}",
    "registered": "{{date(new Date(2014, 0, 1), new Date(), \"YYYY-MM-dd\")}}",
    "location": {
      "lat": "{{floating(48.866667, 90)}}",
      "lon": "{{floating(2.333333, 180)}}"
    },
    "tags": ["{{repeat(7)}}", "{{lorem(1, \"words\")}}"],
    "friends": [
      "{{repeat(3)}}",
      {
        "id": "{{index()}}",
        "name": "{{firstName()}} {{surname()}}"
      }
    ]
  }
]
```

Firstly, we will individually index the objects generated by this site into an index called `person-v1`.

Additionally, we will create an alias `person` pointing to the index we just created.

### Document Manipulation

With the data we just indexed, execute queries to perform the following actions:

- Retrieve a document using the identifier generated by Elasticsearch.
- Modify a document
- Delete a document

### Bulk Queries

To handle bulk queries, index the same documents previously indexed but into a new index `person-v2` using this API.

Make the necessary modification so that the alias `person` points to this new index.

Verify that the queries executed previously are still functional after these modifications.

### Alias

We will create two additional aliases for the index `person-v2`:

- One pointing to documents where the `gender` property is equal to `male`
- One pointing to documents where the `gender` property is equal to `female`

Verify that search queries on one of these indexes return the correct data.

### Search

Perform a simple search using the following syntax to return a subset of the indexed data.

```
GET /person/_search?q=...
```

### Cluster Status

You can check the cluster status with the following request:

```
GET /_cluster/health
```

Can you explain why you get this result? What can you do to have a cluster in a `green` state?

## Lab 2: Schema

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch Mapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html)

Let's start by retrieving the `mapping` of the indexes created previously.

```
GET person-v2/_mapping
```

Create a `template` to define the following mapping (based on the dataset returned by the json-generator.com website):

- The `picture` properties should not be indexed.
- The `eyeColor`, `gender`, `phone` properties should not be analyzed.
- The `name`, `company`, `address`, `about` properties should be analyzed (this representation alone is useful).
- The `registered` field should be of type `Date`. You should specify the supported format. For our data, the format to use will be `yyyy-MM-dd`.
- Convert the `location` object into a `geo_point` object.

Once the template is created, reindex the documents from the `person-v2` index into an index named `person-v3`.

Modify the `person` alias to point to `person-v3`.

Try to find queries that returned results with the old configuration but not anymore. Try to understand why you get this result.

## Lab 3: Search

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)

Now, we will perform searches on the dataset we have just indexed. For this purpose, the trainer will provide you with a bulk request to index a larger number of documents.

Execute queries to answer the following questions:

- How many individuals are females?
- How many individuals are over 20 years old?
- How many males are over 20 years old?
- Return all individuals who are over 20 years old and whose balance is between $1000 and $2000. (you may encounter some issues on this point)
- Find all individuals located within 10km of Paris.

For those who are more advanced in the practical part, you can continue with the following actions:

- From Kibana, try to perform the same searches as defined above from the `Discover` page.

## Lab 4: Aggregation

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch Search Aggregations](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)

In this practical part, we will perform aggregation queries on the data we have just indexed.

- Calculate the average age of indexed individuals.
- Calculate the number of individuals by gender.
- Calculate the number of individuals by gender and eye color.
- Calculate the number of individuals by gender and by registration year (`registered` property).
- For each year, calculate the distribution of genders (male/female) and the average age of individuals. Also, retrieve the year or the highest average age.
- Modify the previous query to only get the buckets of years where the average age is over 28.
- Modify the previous query to find the oldest person in this previously created bucket. Only return certain information (name, age).

For those who are more advanced in the practical part, you can continue with the following actions:

- You can try to implement them using Kibana widgets as well.

## Lab 5: Ingest

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch Ingest Node](https://www.elastic.co/guide/en/elasticsearch/reference/7.10/ingest.html)

The documents we have indexed since the beginning of this training have a property corresponding to a monetary value (`balance`).

You need to set up an ingestion pipeline to remove the currency from each value, convert the data to a float, and save it in a new property called `convertedBalance`.

Once this pipeline is tested and created in Elasticsearch, you can reindex the data from the `person-v3` index into a new index `person-v4` using this pipeline.

Try to perform a `range` query on the `balance` field.

Once the data is reindexed, verify that a `range` query on the `convertedBalance` field works.

## Lab 6: SDK

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch JavaScript Client API](https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/index.html)

In this lab, we will simply initialize a Node.js project to make our first requests to an Elasticsearch cluster.

First, let's initialize the Node.js project. In a new directory, execute the following command:

```
npm init --yes
```

Now, you can install the `@elastic/elasticsearch` dependency.

```
npm install @elastic/elasticsearch
```

In a new file named `src/index.js`, we will import the previously installed module to create an Elasticsearch client.

```javascript
const { Client } = require("@elastic/elasticsearch");
const fs = require("fs");

const client = new Client({
  node: "https://localhost:9200",

  auth: {
    username: "elastic",
    password: "XXX",
  },
  tls: {
    ca: fs.readFileSync("./config/certs/http_ca.crt"),
    rejectUnauthorized: false,
  },
});
```

Once the project is created, you can now add the necessary code in the `src/index.js` file to redo the requests from Labs 4 and 5.

## Lab 7: SQL

To finalize this practical exercise, here are some links that could be useful:

- [Elasticsearch SQL](https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-sql.html)

To manipulate SQL syntax, execute SQL queries to answer the same questions as the labs on aggregations.

- Calculate the average age of indexed individuals
- Calculate the number of individuals by gender
- Calculate the number of individuals by gender and eye color
- Calculate the number of individuals by gender and by registration year (`registered` property).

## Lab 8: Scaling

To finalize this practical exercise, here are some links that could be useful:

- [Running Elasticsearch Locally](https://www.elastic.co/guide/en/elasticsearch/reference/current/run-elasticsearch-locally.html)

In this practical part, we will start a second node in our cluster.

- To do this, we need to retrieve a new `enrollment-token` from the existing node to use it when launching the new node.

```bash
bin/elasticsearch-create-enrollment-token -s node
bin/elasticsearch --enrollment-token <enrollment-token>
```

- Using monitoring APIs, ensure that both nodes are available and communicating properly.

```bash
GET /_cat/indices
```

- Your cluster should now have a `green` status. Why?
- Execute the `GET _cat/shards` request and verify that all shards are correctly assigned.
- Apply a configuration so that shards (primary and replicas) are not placed on the same machine
  (which is the case for now in this training, as we are in a local environment).

- To test the APIs allowing to have an impact on the shard allocation, execute a request to prevent the allocation of our shards
  on one of your two nodes (using the `_name` property for example). The status of your cluster should change.

## Lab 9: Retention

To finalize this practical exercise, here are some links that could be useful:

- [ILM Shrink API](https://www.elastic.co/guide/en/elasticsearch/reference/8.4/ilm-shrink.html)
- [Index Lifecycle Management (ILM)](https://www.elastic.co/guide/en/elasticsearch/reference/8.4/ilm-index-lifecycle.html)

- To manipulate the `Shrink API`, please reindex an existing dataset into a new index with the following configuration:

  - Number of shards: 5
  - Number of replicas: 1

- Use the `Shrink API` to migrate our index to a new index with only 1 shard and no replica shards.

- Via the API or via Kibana's graphical interface, create an ILM to perform this `shrink` operation for all indexes that are one day old.

- Apply this ILM to a new template that you will associate with indexes named `kibana*`. These indexes should also have the following configuration:

  - Number of shards: 5
  - Number of replicas: 1

- Index documents into a new index respecting the previously defined pattern.

- You will need to wait until tomorrow to verify that the `shrink` operation has been executed correctly.

## Lab 10: Alerting

To finalize this practical exercise, here are some links that could be useful:

- [X-Pack Alerting](https://www.elastic.co/guide/en/elasticsearch/reference/8.4/xpack-alerting.html)

In this practical part, we will set up an alerting solution that meets the following criteria:

- Create an alert that

  - Runs every 10 minutes
  - Checks if there is a flight with a delay greater than 0
  - Indexes an alert if at least one document is detected

- Index a new document that meets the previous query.

- Visualize this data from the `Discover` page of Kibana.

## Lab 11: Security

To finalize this practical exercise, here are some links that could be useful:

- [Authentication for Kibana](https://discuss.elastic.co/t/authentication-for-kibana-unknown-setting-xpack-security-enabled/254434/2)

In this lab, we will implement security on our cluster.

- Via the API, create a new role that only grants access to the `person-*` indices.
- Create a new user with the role created previously.
- Ensure that the role and the user created previously are functional (they should not have access to Elasticsearch's internal indices).
- Add constraints to the previously created role on properties and returned documents.
  - For example, the user should not be able to retrieve the `age` property.
  - They should only be able to retrieve documents with the `gender` property equal to `female`.

As a bonus part, you can:

- Create a user from the Kibana graphical interface.
- Create `spaces` and users with access to one of them.

## Lab 12: Snapshot And Restore

To finalize this practical exercise, here are some links that could be useful:

- [Snapshot And Restore APIs](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore-apis.html)

In this lab, we will set up a backup system for our index.

Add the following configuration to the `elasticsearch.yml` configuration file:

```
path:
  repo:
    - ./backups
```

Then restart your node.

You can then create a `repository` named `my fs_backup` of type `fs`.
Take a snapshot of the `person-v3` index in this repository.

Once this snapshot is taken, perform a `restore` to a new index that we will name similarly but suffixed with `_backup`.

- You can also use the `cluster stats` API to view statistics about our cluster and try to understand their meaning.

As a bonus part, you can:

- Repeat the same process but from the Kibana interface.
- Create and execute a SLM (Snapshot Lifecycle Management) policy.

To execute an SLM without waiting, you can use the `_execute` endpoint:

```
POST _slm/policy/nightly-snapshots/_execute
```
